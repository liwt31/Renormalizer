

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>renormalizer.mps.mps &mdash; Renormalizer 0.1.0 documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="../../../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../../" src="../../../_static/documentation_options.js"></script>
        <script type="text/javascript" src="../../../_static/jquery.js"></script>
        <script type="text/javascript" src="../../../_static/underscore.js"></script>
        <script type="text/javascript" src="../../../_static/doctools.js"></script>
        <script type="text/javascript" src="../../../_static/language_data.js"></script>
        <script async="async" type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
    
    <script type="text/javascript" src="../../../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../../index.html" class="icon icon-home"> Renormalizer
          

          
          </a>

          
            
            
              <div class="version">
                0.1
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../../overview.html">1. An overview of Renormalizer</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../tutorial.html">2. Tutorial</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../install.html">3. Installation guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../spectrum.html">4. spectra: absorption/emission spectrum at zero/finite temperature</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../ct.html">5. Charge Transport</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../cv.html">6. Frequency domain DMRG</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../lib.html">7. lib</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../sbm.html">8. sbm</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../configs.html">9. Calculation Configurations</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../mps.html">10. Low Level Data Structure and Algorithms</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../model.html">11. model</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../utils.html">12. some self-built tools</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../develop.html">13. How to develop Renormalizer</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">Renormalizer</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../../index.html">Module code</a> &raquo;</li>
        
      <li>renormalizer.mps.mps</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for renormalizer.mps.mps</h1><div class="highlight"><pre>
<span></span><span class="c1"># -*- encoding: utf-8 -*-</span>

<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">from</span> <span class="nn">functools</span> <span class="k">import</span> <span class="n">wraps</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="k">import</span> <span class="n">Union</span><span class="p">,</span> <span class="n">List</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">scipy</span>

<span class="kn">from</span> <span class="nn">scipy</span> <span class="k">import</span> <span class="n">stats</span>


<span class="kn">from</span> <span class="nn">renormalizer.model</span> <span class="k">import</span> <span class="n">MolList</span>
<span class="kn">from</span> <span class="nn">renormalizer.lib</span> <span class="k">import</span> <span class="n">solve_ivp</span><span class="p">,</span> <span class="n">expm_krylov</span>
<span class="kn">from</span> <span class="nn">renormalizer.mps</span> <span class="k">import</span> <span class="n">svd_qn</span>
<span class="kn">from</span> <span class="nn">renormalizer.mps.matrix</span> <span class="k">import</span> <span class="p">(</span>
    <span class="n">multi_tensor_contract</span><span class="p">,</span>
    <span class="n">ones</span><span class="p">,</span>
    <span class="n">tensordot</span><span class="p">,</span>
    <span class="n">Matrix</span><span class="p">,</span>
    <span class="n">asnumpy</span><span class="p">,)</span>
<span class="kn">from</span> <span class="nn">renormalizer.mps.backend</span> <span class="k">import</span> <span class="n">backend</span><span class="p">,</span> <span class="n">xp</span>
<span class="kn">from</span> <span class="nn">renormalizer.mps.lib</span> <span class="k">import</span> <span class="n">Environ</span><span class="p">,</span> <span class="n">updatemps</span><span class="p">,</span> <span class="n">compressed_sum</span>
<span class="kn">from</span> <span class="nn">renormalizer.mps.mp</span> <span class="k">import</span> <span class="n">MatrixProduct</span>
<span class="kn">from</span> <span class="nn">renormalizer.mps.mpo</span> <span class="k">import</span> <span class="n">Mpo</span>
<span class="kn">from</span> <span class="nn">renormalizer.mps.tdh</span> <span class="k">import</span> <span class="n">mflib</span>
<span class="kn">from</span> <span class="nn">renormalizer.mps.tdh</span> <span class="k">import</span> <span class="n">unitary_propagation</span>
<span class="kn">from</span> <span class="nn">renormalizer.utils</span> <span class="k">import</span> <span class="p">(</span>
    <span class="n">Quantity</span><span class="p">,</span>
    <span class="n">OptimizeConfig</span><span class="p">,</span>
    <span class="n">CompressCriteria</span><span class="p">,</span>
    <span class="n">CompressConfig</span><span class="p">,</span>
    <span class="n">EvolveConfig</span><span class="p">,</span>
    <span class="n">EvolveMethod</span><span class="p">,</span>
    <span class="n">sizeof_fmt</span><span class="p">,</span>
<span class="p">)</span>

<span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">adaptive_tdvp</span><span class="p">(</span><span class="n">fun</span><span class="p">):</span>
    <span class="c1"># evolve t/2 (twice) and t to obtain the O(dt^3) error term in 2nd-order Trotter decomposition</span>
    <span class="c1">#J. Chem. Phys. 146, 174107 (2017)</span>

    <span class="nd">@wraps</span><span class="p">(</span><span class="n">fun</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">f</span><span class="p">(</span><span class="bp">self</span><span class="p">:</span> <span class="s2">&quot;Mps&quot;</span><span class="p">,</span> <span class="n">mpo</span><span class="p">,</span> <span class="n">evolve_dt</span><span class="p">):</span>
        
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">evolve_config</span><span class="o">.</span><span class="n">adaptive</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">fun</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mpo</span><span class="p">,</span> <span class="n">evolve_dt</span><span class="p">)</span>
        <span class="n">config</span><span class="p">:</span> <span class="n">EvolveConfig</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">evolve_config</span>
        <span class="n">config</span><span class="o">.</span><span class="n">check_valid_dt</span><span class="p">(</span><span class="n">evolve_dt</span><span class="p">)</span>
        
        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            
            <span class="n">dt</span> <span class="o">=</span> <span class="n">min_abs</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">guess_dt</span><span class="p">,</span> <span class="n">evolve_dt</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                    <span class="n">f</span><span class="s2">&quot;guess_dt: </span><span class="si">{config.guess_dt}</span><span class="s2">, try time step size: </span><span class="si">{dt}</span><span class="s2">&quot;</span>
            <span class="p">)</span>

            <span class="n">mps_half1</span> <span class="o">=</span> <span class="n">fun</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mpo</span><span class="p">,</span> <span class="n">dt</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">_dmrg_normalize</span><span class="p">()</span>
            <span class="n">mps_half2</span> <span class="o">=</span> <span class="n">fun</span><span class="p">(</span><span class="n">mps_half1</span><span class="p">,</span> <span class="n">mpo</span><span class="p">,</span> <span class="n">dt</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">_dmrg_normalize</span><span class="p">()</span>
            <span class="n">mps</span> <span class="o">=</span> <span class="n">fun</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mpo</span><span class="p">,</span> <span class="n">dt</span><span class="p">)</span><span class="o">.</span><span class="n">_dmrg_normalize</span><span class="p">()</span>
            
            <span class="k">del</span> <span class="n">mps_half1</span>

            <span class="n">dis</span> <span class="o">=</span> <span class="n">mps</span><span class="o">.</span><span class="n">distance</span><span class="p">(</span><span class="n">mps_half2</span><span class="p">)</span>
            <span class="n">p</span> <span class="o">=</span> <span class="p">(</span><span class="mf">0.75</span> <span class="o">*</span> <span class="n">config</span><span class="o">.</span><span class="n">adaptive_rtol</span> <span class="o">/</span> <span class="p">(</span><span class="n">dis</span> <span class="o">+</span> <span class="mf">1e-30</span><span class="p">))</span> <span class="o">**</span> <span class="p">(</span><span class="mf">1.</span><span class="o">/</span><span class="mi">3</span><span class="p">)</span>    
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;distance: </span><span class="si">{dis}</span><span class="s2">, enlarge p parameter: </span><span class="si">{p}</span><span class="s2">&quot;</span><span class="p">)</span>
            
            <span class="n">p_restart</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="c1"># restart threshold </span>
            <span class="n">p_min</span> <span class="o">=</span> <span class="mf">0.1</span>     <span class="c1"># safeguard for minimal allowed p</span>
            <span class="n">p_max</span> <span class="o">=</span> <span class="mf">2.</span>      <span class="c1"># safeguard for maximal allowed p</span>

            <span class="k">if</span> <span class="n">xp</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">dt</span><span class="p">,</span> <span class="n">evolve_dt</span><span class="p">):</span>  
                <span class="c1"># approahes the end </span>
                <span class="k">if</span> <span class="n">p</span> <span class="o">&lt;</span> <span class="n">p_restart</span><span class="p">:</span>
                    <span class="c1"># not accurate in this final sub-step will restart</span>
                    <span class="n">config</span><span class="o">.</span><span class="n">guess_dt</span> <span class="o">=</span> <span class="n">dt</span> <span class="o">*</span> <span class="nb">max</span><span class="p">(</span><span class="n">p_min</span><span class="p">,</span> <span class="n">p</span><span class="p">)</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                        <span class="n">f</span><span class="s2">&quot;evolution not converged, new guess_dt: </span><span class="si">{config.guess_dt}</span><span class="s2">&quot;</span>
                    <span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># normal exit</span>
                    <span class="n">mps_half2</span><span class="o">.</span><span class="n">evolve_config</span><span class="o">.</span><span class="n">guess_dt</span> <span class="o">=</span> <span class="n">min_abs</span><span class="p">(</span><span class="n">dt</span><span class="o">*</span><span class="n">p</span><span class="p">,</span> <span class="n">config</span><span class="o">.</span><span class="n">guess_dt</span><span class="p">)</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                        <span class="n">f</span><span class="s2">&quot;evolution converged, new guess_dt: </span><span class="si">{mps_half2.evolve_config.guess_dt}</span><span class="s2">&quot;</span>
                    <span class="p">)</span>
                    <span class="k">return</span> <span class="n">mps_half2</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># sub-steps </span>
                <span class="k">if</span> <span class="n">p</span> <span class="o">&lt;</span> <span class="n">p_restart</span><span class="p">:</span>
                    <span class="c1"># not accurate in this sub-step, will restart</span>
                    <span class="n">config</span><span class="o">.</span><span class="n">guess_dt</span> <span class="o">*=</span> <span class="nb">max</span><span class="p">(</span><span class="n">p_min</span><span class="p">,</span> <span class="n">p</span><span class="p">)</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                        <span class="n">f</span><span class="s2">&quot;evolution not converged, new guess_dt: </span><span class="si">{config.guess_dt}</span><span class="s2">&quot;</span>
                    <span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># sub-step converge</span>
                    <span class="n">new_dt</span> <span class="o">=</span> <span class="n">evolve_dt</span> <span class="o">-</span> <span class="n">dt</span>
                    <span class="n">config</span><span class="o">.</span><span class="n">guess_dt</span> <span class="o">*=</span> <span class="nb">min</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">p_max</span><span class="p">)</span> 
                    <span class="n">mps_half2</span><span class="o">.</span><span class="n">evolve_config</span><span class="o">.</span><span class="n">guess_dt</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">guess_dt</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                        <span class="n">f</span><span class="s2">&quot;evolution converged, new guess_dt: </span><span class="si">{config.guess_dt}</span><span class="s2">&quot;</span>
                    <span class="p">)</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;sub-step </span><span class="si">{dt}</span><span class="s2"> further, remaining: </span><span class="si">{new_dt}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="k">return</span> <span class="n">f</span><span class="p">(</span><span class="n">mps_half2</span><span class="p">,</span> <span class="n">mpo</span><span class="p">,</span> <span class="n">new_dt</span><span class="p">)</span>
            
    <span class="k">return</span> <span class="n">f</span>


<div class="viewcode-block" id="Mps"><a class="viewcode-back" href="../../../mps.html#renormalizer.mps.Mps">[docs]</a><span class="k">class</span> <span class="nc">Mps</span><span class="p">(</span><span class="n">MatrixProduct</span><span class="p">):</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">random</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">mol_list</span><span class="p">:</span> <span class="n">MolList</span><span class="p">,</span> <span class="n">nexciton</span><span class="p">,</span> <span class="n">m_max</span><span class="p">,</span> <span class="n">percent</span><span class="o">=</span><span class="mf">1.0</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;Mps&quot;</span><span class="p">:</span>
        <span class="c1"># a high percent makes the result more random</span>
        <span class="c1"># sometimes critical for getting correct optimization result</span>
        <span class="n">mps</span> <span class="o">=</span> <span class="bp">cls</span><span class="p">()</span>
        <span class="n">mps</span><span class="o">.</span><span class="n">mol_list</span> <span class="o">=</span> <span class="n">mol_list</span>
        <span class="n">mps</span><span class="o">.</span><span class="n">qn</span> <span class="o">=</span> <span class="p">[[</span><span class="mi">0</span><span class="p">]]</span>
        <span class="n">dim_list</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">]</span>

        <span class="k">for</span> <span class="n">imps</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">mol_list</span><span class="o">.</span><span class="n">ephtable</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">):</span>

            <span class="c1"># quantum number</span>
            <span class="n">qnbig</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">add</span><span class="o">.</span><span class="n">outer</span><span class="p">(</span><span class="n">mps</span><span class="o">.</span><span class="n">qn</span><span class="p">[</span><span class="n">imps</span><span class="p">],</span> <span class="n">mps</span><span class="o">.</span><span class="n">_get_sigmaqn</span><span class="p">(</span><span class="n">imps</span><span class="p">))</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
            <span class="n">u_set</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">s_set</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">qnset</span> <span class="o">=</span> <span class="p">[]</span>

            <span class="k">for</span> <span class="n">iblock</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="n">qnbig</span><span class="p">),</span> <span class="n">nexciton</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
                <span class="c1"># find the quantum number index</span>
                <span class="n">indices</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">qnbig</span><span class="p">)</span> <span class="k">if</span> <span class="n">x</span> <span class="o">==</span> <span class="n">iblock</span><span class="p">]</span>

                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">indices</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">a</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">([</span><span class="nb">len</span><span class="p">(</span><span class="n">indices</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">indices</span><span class="p">)])</span> <span class="o">-</span> <span class="mf">0.5</span>
                    <span class="n">a</span> <span class="o">=</span> <span class="n">a</span> <span class="o">+</span> <span class="n">a</span><span class="o">.</span><span class="n">T</span>
                    <span class="n">s</span><span class="p">,</span> <span class="n">u</span> <span class="o">=</span> <span class="n">scipy</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">eigh</span><span class="p">(</span><span class="n">a</span><span class="o">=</span><span class="n">a</span><span class="p">)</span>
                    <span class="n">u_set</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">svd_qn</span><span class="o">.</span><span class="n">blockrecover</span><span class="p">(</span><span class="n">indices</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">qnbig</span><span class="p">)))</span>
                    <span class="n">s_set</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
                    <span class="n">qnset</span> <span class="o">+=</span> <span class="p">[</span><span class="n">iblock</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">indices</span><span class="p">)</span>

            <span class="n">u_set</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">u_set</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">s_set</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">s_set</span><span class="p">)</span>
            <span class="n">mt</span><span class="p">,</span> <span class="n">mpsdim</span><span class="p">,</span> <span class="n">mpsqn</span><span class="p">,</span> <span class="n">nouse</span> <span class="o">=</span> <span class="n">updatemps</span><span class="p">(</span>
                <span class="n">u_set</span><span class="p">,</span> <span class="n">s_set</span><span class="p">,</span> <span class="n">qnset</span><span class="p">,</span> <span class="n">u_set</span><span class="p">,</span> <span class="n">nexciton</span><span class="p">,</span> <span class="n">m_max</span><span class="p">,</span> <span class="n">percent</span><span class="o">=</span><span class="n">percent</span>
            <span class="p">)</span>
            <span class="c1"># add the next mpsdim</span>
            <span class="n">dim_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">mpsdim</span><span class="p">)</span>
            <span class="n">mps</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="n">mt</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">dim_list</span><span class="p">[</span><span class="n">imps</span><span class="p">],</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">dim_list</span><span class="p">[</span><span class="n">imps</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]))</span>
            <span class="p">)</span>
            <span class="n">mps</span><span class="o">.</span><span class="n">qn</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">mpsqn</span><span class="p">)</span>

        <span class="c1"># the last site</span>
        <span class="n">mps</span><span class="o">.</span><span class="n">qn</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">dim_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">last_mt</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">xp</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">([</span><span class="n">dim_list</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">],</span> <span class="n">mps</span><span class="o">.</span><span class="n">pbond_list</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">dim_list</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]])</span> <span class="o">-</span> <span class="mf">0.5</span>
        <span class="p">)</span>
        <span class="c1"># normalize the mt so that the whole mps is normalized</span>
        <span class="n">last_mt</span> <span class="o">/=</span> <span class="n">xp</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">last_mt</span><span class="o">.</span><span class="n">flatten</span><span class="p">())</span>
        <span class="n">mps</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">last_mt</span><span class="p">)</span>

        <span class="n">mps</span><span class="o">.</span><span class="n">qnidx</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">mps</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>
        <span class="n">mps</span><span class="o">.</span><span class="n">to_right</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">mps</span><span class="o">.</span><span class="n">qntot</span> <span class="o">=</span> <span class="n">nexciton</span>

        <span class="c1"># print(&quot;self.dim&quot;, self.dim)</span>

        <span class="n">mps</span><span class="o">.</span><span class="n">tdh_wfns</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">mol</span> <span class="ow">in</span> <span class="n">mps</span><span class="o">.</span><span class="n">mol_list</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">ph</span> <span class="ow">in</span> <span class="n">mol</span><span class="o">.</span><span class="n">hartree_phs</span><span class="p">:</span>
                <span class="n">mps</span><span class="o">.</span><span class="n">tdh_wfns</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">(</span><span class="n">ph</span><span class="o">.</span><span class="n">n_phys_dim</span><span class="p">))</span>
        <span class="n">mps</span><span class="o">.</span><span class="n">tdh_wfns</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mf">1.0</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">mps</span>

<div class="viewcode-block" id="Mps.gs"><a class="viewcode-back" href="../../../mps.html#renormalizer.mps.Mps.gs">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">gs</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">mol_list</span><span class="p">:</span> <span class="n">MolList</span><span class="p">,</span> <span class="n">max_entangled</span><span class="p">:</span> <span class="nb">bool</span><span class="p">):</span>
        <span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Obtain ground state at :math:`T = 0` or :math:`T = \infty` (maximum entangled).</span>
<span class="sd">        Electronic DOFs are always at ground state. and vibrational DOFs depend on ``max_entangled``.</span>
<span class="sd">        For Spin-Boson model the electronic DOF also depends on ``max_entangled``.</span>

<span class="sd">        Args:</span>
<span class="sd">            mol_list (:class:`~renormalizer.model.MolList`): system information.</span>
<span class="sd">            max_entanggled (bool): temperature of the vibrational DOFs. If set to ``True``,</span>
<span class="sd">                :math:`T = \infty` and if set to ``False``, :math:`T = 0`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">mps</span> <span class="o">=</span> <span class="bp">cls</span><span class="p">()</span>
        <span class="n">mps</span><span class="o">.</span><span class="n">mol_list</span> <span class="o">=</span> <span class="n">mol_list</span>
        <span class="n">mps</span><span class="o">.</span><span class="n">qn</span> <span class="o">=</span> <span class="p">[[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">*</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">mps</span><span class="o">.</span><span class="n">ephtable</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">mps</span><span class="o">.</span><span class="n">qnidx</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">mps</span><span class="o">.</span><span class="n">ephtable</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>
        <span class="n">mps</span><span class="o">.</span><span class="n">to_right</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">mps</span><span class="o">.</span><span class="n">qntot</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="k">for</span> <span class="n">imol</span><span class="p">,</span> <span class="n">mol</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">mol_list</span><span class="p">):</span>
            <span class="c1"># electron mps</span>
            <span class="k">if</span> <span class="mi">0</span> <span class="o">&lt;</span> <span class="n">mol_list</span><span class="o">.</span><span class="n">scheme</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">mol</span><span class="o">.</span><span class="n">sbm</span> <span class="ow">and</span> <span class="n">max_entangled</span><span class="p">:</span>
                    <span class="n">array</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">1</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span> <span class="mi">1</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">2</span><span class="p">)])</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">array</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span>
                <span class="n">mps</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">array</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">)))</span>
            <span class="k">elif</span> <span class="n">mol_list</span><span class="o">.</span><span class="n">scheme</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>
                <span class="k">assert</span> <span class="ow">not</span> <span class="n">mol</span><span class="o">.</span><span class="n">sbm</span>
                <span class="k">if</span> <span class="n">imol</span> <span class="o">==</span> <span class="n">mol_list</span><span class="o">.</span><span class="n">mol_num</span> <span class="o">//</span> <span class="mi">2</span><span class="p">:</span>
                    <span class="n">array</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">mol_list</span><span class="o">.</span><span class="n">mol_num</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
                    <span class="n">array</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
                    <span class="n">mps</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">array</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">assert</span> <span class="kc">False</span>
            <span class="c1"># ph mps</span>
            <span class="k">for</span> <span class="n">ph</span> <span class="ow">in</span> <span class="n">mol</span><span class="o">.</span><span class="n">dmrg_phs</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">iboson</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ph</span><span class="o">.</span><span class="n">nqboson</span><span class="p">):</span>
                    <span class="n">ms</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span> <span class="n">ph</span><span class="o">.</span><span class="n">base</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
                    <span class="k">if</span> <span class="n">max_entangled</span><span class="p">:</span>
                        <span class="n">ms</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">ph</span><span class="o">.</span><span class="n">base</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">ms</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0</span>
                    <span class="n">mps</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ms</span><span class="p">)</span>

        <span class="n">mps</span><span class="o">.</span><span class="n">tdh_wfns</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">mol</span> <span class="ow">in</span> <span class="n">mol_list</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">ph</span> <span class="ow">in</span> <span class="n">mol</span><span class="o">.</span><span class="n">hartree_phs</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">max_entangled</span><span class="p">:</span>
                    <span class="n">diag_elems</span> <span class="o">=</span> <span class="p">[</span><span class="mf">1.0</span><span class="p">]</span> <span class="o">*</span> <span class="n">ph</span><span class="o">.</span><span class="n">n_phys_dim</span>
                    <span class="n">mps</span><span class="o">.</span><span class="n">tdh_wfns</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">diag_elems</span><span class="p">))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">diag_elems</span> <span class="o">=</span> <span class="p">[</span><span class="mf">1.0</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">ph</span><span class="o">.</span><span class="n">n_phys_dim</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
                    <span class="n">mps</span><span class="o">.</span><span class="n">tdh_wfns</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">diag_elems</span><span class="p">))</span>
        <span class="c1"># the coefficent a</span>
        <span class="n">mps</span><span class="o">.</span><span class="n">tdh_wfns</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mf">1.0</span><span class="p">)</span>

        <span class="n">mflib</span><span class="o">.</span><span class="n">normalize</span><span class="p">(</span><span class="n">mps</span><span class="o">.</span><span class="n">tdh_wfns</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">mps</span></div>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">load</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">mol_list</span><span class="p">:</span> <span class="n">MolList</span><span class="p">,</span> <span class="n">fname</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">npload</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="n">allow_pickle</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">mp</span> <span class="o">=</span> <span class="bp">cls</span><span class="p">()</span>
        <span class="n">mp</span><span class="o">.</span><span class="n">mol_list</span> <span class="o">=</span> <span class="n">mol_list</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">npload</span><span class="p">[</span><span class="s2">&quot;nsites&quot;</span><span class="p">])):</span>
            <span class="n">mt</span> <span class="o">=</span> <span class="n">npload</span><span class="p">[</span><span class="n">f</span><span class="s2">&quot;mt_</span><span class="si">{i}</span><span class="s2">&quot;</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">iscomplexobj</span><span class="p">(</span><span class="n">mt</span><span class="p">):</span>
                <span class="n">mp</span><span class="o">.</span><span class="n">dtype</span> <span class="o">=</span> <span class="n">backend</span><span class="o">.</span><span class="n">complex_dtype</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">mp</span><span class="o">.</span><span class="n">dtype</span> <span class="o">=</span> <span class="n">backend</span><span class="o">.</span><span class="n">real_dtype</span>
            <span class="n">mp</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">mt</span><span class="p">)</span>
        <span class="n">mp</span><span class="o">.</span><span class="n">qn</span> <span class="o">=</span> <span class="n">npload</span><span class="p">[</span><span class="s2">&quot;qn&quot;</span><span class="p">]</span>
        <span class="n">mp</span><span class="o">.</span><span class="n">qnidx</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">npload</span><span class="p">[</span><span class="s2">&quot;qnidx&quot;</span><span class="p">])</span>
        <span class="n">mp</span><span class="o">.</span><span class="n">qntot</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">npload</span><span class="p">[</span><span class="s2">&quot;qntot&quot;</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">npload</span><span class="p">[</span><span class="s2">&quot;version&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;0.1&quot;</span><span class="p">:</span>
            <span class="n">mp</span><span class="o">.</span><span class="n">to_right</span> <span class="o">=</span> <span class="nb">bool</span><span class="p">(</span><span class="n">npload</span><span class="p">[</span><span class="s2">&quot;left&quot;</span><span class="p">])</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Using old dump/load protocol. TD Hartree part will be lost&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">mp</span><span class="o">.</span><span class="n">to_right</span> <span class="o">=</span> <span class="nb">bool</span><span class="p">(</span><span class="n">npload</span><span class="p">[</span><span class="s2">&quot;to_right&quot;</span><span class="p">])</span>
            <span class="n">mp</span><span class="o">.</span><span class="n">tdh_wfns</span> <span class="o">=</span> <span class="n">npload</span><span class="p">[</span><span class="s2">&quot;tdh_wfns&quot;</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">mp</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">Mps</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="c1"># todo: tdh part with GPU backend</span>
        <span class="c1"># tdh part will merge into tdvp evolution scheme in the future</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tdh_wfns</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">optimize_config</span><span class="p">:</span> <span class="n">OptimizeConfig</span> <span class="o">=</span> <span class="n">OptimizeConfig</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">evolve_config</span><span class="p">:</span> <span class="n">EvolveConfig</span> <span class="o">=</span> <span class="n">EvolveConfig</span><span class="p">()</span>

<div class="viewcode-block" id="Mps.conj"><a class="viewcode-back" href="../../../mps.html#renormalizer.mps.Mps.conj">[docs]</a>    <span class="k">def</span> <span class="nf">conj</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;Mps&quot;</span><span class="p">:</span>
        <span class="n">new_mps</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">conj</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">wfn</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">new_mps</span><span class="o">.</span><span class="n">tdh_wfns</span><span class="p">):</span>
            <span class="n">new_mps</span><span class="o">.</span><span class="n">tdh_wfns</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">conj</span><span class="p">(</span><span class="n">wfn</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">new_mps</span></div>

<div class="viewcode-block" id="Mps.dot"><a class="viewcode-back" href="../../../mps.html#renormalizer.mps.Mps.dot">[docs]</a>    <span class="k">def</span> <span class="nf">dot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">:</span> <span class="s2">&quot;Mps&quot;</span><span class="p">,</span> <span class="n">with_hartree</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="n">e</span> <span class="o">=</span> <span class="nb">super</span><span class="p">(</span><span class="n">Mps</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">other</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">with_hartree</span><span class="p">:</span>
            <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tdh_wfns</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">other</span><span class="o">.</span><span class="n">tdh_wfns</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">wfn1</span><span class="p">,</span> <span class="n">wfn2</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tdh_wfns</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">other</span><span class="o">.</span><span class="n">tdh_wfns</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]):</span>
                <span class="c1"># using vdot is buggy here, because vdot will take conjugation automatically</span>
                <span class="n">e</span> <span class="o">*=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">wfn1</span><span class="p">,</span> <span class="n">wfn2</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">e</span></div>

    <span class="k">def</span> <span class="nf">to_complex</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;Mps&quot;</span><span class="p">:</span>
        <span class="n">new_mp</span> <span class="o">=</span> <span class="nb">super</span><span class="p">(</span><span class="n">Mps</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">to_complex</span><span class="p">(</span><span class="n">inplace</span><span class="o">=</span><span class="n">inplace</span><span class="p">)</span>
        <span class="n">new_mp</span><span class="o">.</span><span class="n">tdh_wfns</span> <span class="o">=</span> <span class="p">[</span><span class="n">wfn</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">complex128</span><span class="p">)</span> <span class="k">for</span> <span class="n">wfn</span> <span class="ow">in</span> <span class="n">new_mp</span><span class="o">.</span><span class="n">tdh_wfns</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]]</span> <span class="o">+</span> <span class="p">[</span>
            <span class="n">new_mp</span><span class="o">.</span><span class="n">tdh_wfns</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="p">]</span>
        <span class="k">return</span> <span class="n">new_mp</span>

    <span class="k">def</span> <span class="nf">_get_sigmaqn</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">idx</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ephtable</span><span class="o">.</span><span class="n">is_phonon</span><span class="p">(</span><span class="n">idx</span><span class="p">):</span>
            <span class="k">return</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">pbond_list</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mol_list</span><span class="o">.</span><span class="n">scheme</span> <span class="o">&lt;</span> <span class="mi">4</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">ephtable</span><span class="o">.</span><span class="n">is_electron</span><span class="p">(</span><span class="n">idx</span><span class="p">):</span>
            <span class="k">return</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">mol_list</span><span class="o">.</span><span class="n">scheme</span> <span class="o">==</span> <span class="mi">4</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">ephtable</span><span class="o">.</span><span class="n">is_electrons</span><span class="p">(</span><span class="n">idx</span><span class="p">):</span>
            <span class="k">return</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pbond_list</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">assert</span> <span class="kc">False</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">is_mps</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="kc">True</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">is_mpo</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="kc">False</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">is_mpdm</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="kc">False</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">coeff</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">tdh_wfns</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">hybrid_tdh</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">mol_list</span><span class="o">.</span><span class="n">pure_dmrg</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">nexciton</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">qntot</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">norm</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># return self.dmrg_norm * self.hartree_norm</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">tdh_wfns</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">dmrg_norm</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
        <span class="c1"># the fast version in the comment rarely makes sense because in a lot of cases</span>
        <span class="c1"># the mps is not canonicalised (though qnidx is set)</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        if self.is_left_canon:</span>
<span class="sd">            assert self.check_left_canonical()</span>
<span class="sd">            return np.linalg.norm(np.ravel(self[-1]))</span>
<span class="sd">        else:</span>
<span class="sd">            assert self.check_right_canonical()</span>
<span class="sd">            return np.linalg.norm(np.ravel(self[0]))</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">conj</span><span class="p">()</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">with_hartree</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">real</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">float</span><span class="p">(</span><span class="n">res</span><span class="o">.</span><span class="n">real</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_expectation_path</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># S--a--S--e--S</span>
        <span class="c1"># |     |     |</span>
        <span class="c1"># |     d     |</span>
        <span class="c1"># |     |     |</span>
        <span class="c1"># O--b--O--g--O</span>
        <span class="c1"># |     |     |</span>
        <span class="c1"># |     f     |</span>
        <span class="c1"># |     |     |</span>
        <span class="c1"># S--c--S--h--S</span>
        <span class="n">path</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="s2">&quot;abc, cfh -&gt; abfh&quot;</span><span class="p">),</span>
            <span class="p">([</span><span class="mi">3</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="s2">&quot;abfh, bdfg -&gt; ahdg&quot;</span><span class="p">),</span>
            <span class="p">([</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="s2">&quot;ahdg, ade -&gt; hge&quot;</span><span class="p">),</span>
            <span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="s2">&quot;hge, egh -&gt; &quot;</span><span class="p">),</span>
        <span class="p">]</span>
        <span class="k">return</span> <span class="n">path</span>

    <span class="k">def</span> <span class="nf">_expectation_conj</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">conj</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">expectation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mpo</span><span class="p">,</span> <span class="n">self_conj</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">self_conj</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">self_conj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_expectation_conj</span><span class="p">()</span>
        <span class="n">environ</span> <span class="o">=</span> <span class="n">Environ</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mpo</span><span class="p">,</span> <span class="s2">&quot;R&quot;</span><span class="p">,</span> <span class="n">mps_conj</span><span class="o">=</span><span class="n">self_conj</span><span class="p">)</span>
        <span class="n">l</span> <span class="o">=</span> <span class="n">ones</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">environ</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="s2">&quot;R&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_expectation_path</span><span class="p">()</span>
        <span class="k">return</span> <span class="nb">float</span><span class="p">(</span><span class="n">multi_tensor_contract</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">l</span><span class="p">,</span> <span class="bp">self</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">mpo</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">self_conj</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">r</span><span class="p">)</span><span class="o">.</span><span class="n">real</span><span class="p">)</span>
        <span class="c1"># This is time and memory consuming</span>
        <span class="c1"># return self_conj.dot(mpo.apply(self), with_hartree=False).real</span>

    <span class="k">def</span> <span class="nf">expectations</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mpos</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">mpos</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">expectation</span><span class="p">(</span><span class="n">mpo</span><span class="p">)</span> <span class="k">for</span> <span class="n">mpo</span> <span class="ow">in</span> <span class="n">mpos</span><span class="p">])</span>
        <span class="k">assert</span> <span class="mi">2</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">mpos</span><span class="p">)</span>
        <span class="c1"># id can be used as efficient hash because of `Matrix` implementation</span>
        <span class="n">mpo_ids</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="nb">id</span><span class="p">(</span><span class="n">m</span><span class="p">)</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">mpo</span><span class="p">]</span> <span class="k">for</span> <span class="n">mpo</span> <span class="ow">in</span> <span class="n">mpos</span><span class="p">])</span>
        <span class="n">common_mpo_ids</span> <span class="o">=</span> <span class="n">mpo_ids</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">mpo0_unique_idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">mpo_ids</span> <span class="o">==</span> <span class="n">common_mpo_ids</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">common_mpo_ids</span><span class="p">[</span><span class="n">mpo0_unique_idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">mpo_ids</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">mpo0_unique_idx</span><span class="p">]</span>
        <span class="n">x</span><span class="p">,</span> <span class="n">unique_idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">mpo_ids</span> <span class="o">!=</span> <span class="n">common_mpo_ids</span><span class="p">)</span>
        <span class="c1"># should find one at each line</span>
        <span class="k">assert</span> <span class="n">xp</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">mpos</span><span class="p">)))</span>
        <span class="n">common_mpo</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">mpos</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">common_mpo</span><span class="p">[</span><span class="n">mpo0_unique_idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">mpos</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">mpo0_unique_idx</span><span class="p">]</span>
        <span class="n">self_conj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_expectation_conj</span><span class="p">()</span>
        <span class="n">environ</span> <span class="o">=</span> <span class="n">Environ</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">common_mpo</span><span class="p">,</span> <span class="n">mps_conj</span><span class="o">=</span><span class="n">self_conj</span><span class="p">)</span>
        <span class="n">res_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">mpo</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">unique_idx</span><span class="p">,</span> <span class="n">mpos</span><span class="p">):</span>
            <span class="n">l</span> <span class="o">=</span> <span class="n">environ</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="s2">&quot;L&quot;</span><span class="p">,</span> <span class="n">idx</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">r</span> <span class="o">=</span> <span class="n">environ</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="s2">&quot;R&quot;</span><span class="p">,</span> <span class="n">idx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_expectation_path</span><span class="p">()</span>
            <span class="n">res</span> <span class="o">=</span> <span class="n">multi_tensor_contract</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">l</span><span class="p">,</span> <span class="bp">self</span><span class="p">[</span><span class="n">idx</span><span class="p">],</span> <span class="n">mpo</span><span class="p">[</span><span class="n">idx</span><span class="p">],</span> <span class="n">self_conj</span><span class="p">[</span><span class="n">idx</span><span class="p">],</span> <span class="n">r</span><span class="p">)</span>
            <span class="n">res_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">res</span><span class="o">.</span><span class="n">real</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">res_list</span><span class="p">)</span>
        <span class="c1"># the naive way, slow and time consuming</span>
        <span class="c1"># return np.array([self.expectation(mpo) for mpo in mpos])</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">ph_occupations</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">key</span> <span class="o">=</span> <span class="s2">&quot;ph_occupations&quot;</span>
        <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">mol_list</span><span class="o">.</span><span class="n">mpos</span><span class="p">:</span>
            <span class="n">mpos</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">imol</span><span class="p">,</span> <span class="n">mol</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mol_list</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">iph</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">mol</span><span class="o">.</span><span class="n">dmrg_phs</span><span class="p">)):</span>
                    <span class="n">mpos</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Mpo</span><span class="o">.</span><span class="n">ph_onsite</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mol_list</span><span class="p">,</span> <span class="sa">r</span><span class="s2">&quot;b^\dagger b&quot;</span><span class="p">,</span> <span class="n">imol</span><span class="p">,</span> <span class="n">iph</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mol_list</span><span class="o">.</span><span class="n">mpos</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">mpos</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">mpos</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mol_list</span><span class="o">.</span><span class="n">mpos</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">expectations</span><span class="p">(</span><span class="n">mpos</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">e_occupations</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mol_list</span><span class="o">.</span><span class="n">scheme</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">:</span>
            <span class="n">key</span> <span class="o">=</span> <span class="s2">&quot;e_occupations&quot;</span>
            <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">mol_list</span><span class="o">.</span><span class="n">mpos</span><span class="p">:</span>
                <span class="n">mpos</span> <span class="o">=</span> <span class="p">[</span>
                    <span class="n">Mpo</span><span class="o">.</span><span class="n">onsite</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mol_list</span><span class="p">,</span> <span class="sa">r</span><span class="s2">&quot;a^\dagger a&quot;</span><span class="p">,</span> <span class="n">mol_idx_set</span><span class="o">=</span><span class="p">{</span><span class="n">i</span><span class="p">})</span>
                    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mol_num</span><span class="p">)</span>
                <span class="p">]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">mol_list</span><span class="o">.</span><span class="n">mpos</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">mpos</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">mpos</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mol_list</span><span class="o">.</span><span class="n">mpos</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">expectations</span><span class="p">(</span><span class="n">mpos</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">mol_list</span><span class="o">.</span><span class="n">scheme</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>
            <span class="c1"># get rdm is very fast</span>
            <span class="n">rdm</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calc_reduced_density_matrix</span><span class="p">()</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">rdm</span><span class="p">)</span><span class="o">.</span><span class="n">real</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">assert</span> <span class="kc">False</span>

    <span class="k">def</span> <span class="nf">metacopy</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;Mps&quot;</span><span class="p">:</span>
        <span class="n">new</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">metacopy</span><span class="p">()</span>
        <span class="n">new</span><span class="o">.</span><span class="n">tdh_wfns</span> <span class="o">=</span> <span class="p">[</span><span class="n">wfn</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span> <span class="k">for</span> <span class="n">wfn</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">tdh_wfns</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]]</span> <span class="o">+</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">tdh_wfns</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]]</span>
        <span class="n">new</span><span class="o">.</span><span class="n">optimize_config</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">optimize_config</span>
        <span class="c1"># evolve_config has its own data</span>
        <span class="n">new</span><span class="o">.</span><span class="n">evolve_config</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">evolve_config</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">new</span>

    <span class="k">def</span> <span class="nf">_dmrg_normalize</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">scale</span><span class="p">(</span><span class="mf">1.0</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">dmrg_norm</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">normalize</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">norm</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="c1"># real time propagation: dmrg should be normalized, tdh should be normalized, coefficient is not changed,</span>
        <span class="c1">#  use norm=None</span>
        <span class="c1"># imag time propagation: dmrg should be normalized, tdh should be normalized, coefficient is normalized to 1.0</span>
        <span class="c1"># applied by a operator then normalize: dmrg should be normalized,</span>
        <span class="c1">#   tdh should be normalized, coefficient is set to the length</span>
        <span class="c1"># these two cases should set `norm` equals to corresponding value</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_dmrg_normalize</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">norm</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">mflib</span><span class="o">.</span><span class="n">normalize</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tdh_wfns</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">tdh_wfns</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">mflib</span><span class="o">.</span><span class="n">normalize</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tdh_wfns</span><span class="p">,</span> <span class="n">norm</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span> <span class="nf">canonical_normalize</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># applied by a operator then normalize: dmrg should be normalized,</span>
        <span class="c1">#   tdh should be normalized, coefficient is set to the length</span>
        <span class="c1"># suppose length is only determined by dmrg part</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">normalize</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dmrg_norm</span><span class="p">)</span>

<div class="viewcode-block" id="Mps.expand_bond_dimension"><a class="viewcode-back" href="../../../mps.html#renormalizer.mps.Mps.expand_bond_dimension">[docs]</a>    <span class="k">def</span> <span class="nf">expand_bond_dimension</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">hint_mpo</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">coef</span><span class="o">=</span><span class="mf">1e-10</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        expand bond dimension as required in compress_config</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_dummy_qn</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">nexciton</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Expanding bond dimensional without exciton is meaningless&quot;</span><span class="p">)</span>
        <span class="n">m_target</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compress_config</span><span class="o">.</span><span class="n">bond_dim_max_value</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;target for expanding: </span><span class="si">{m_target}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">hint_mpo</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">expander</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="n">random</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mol_list</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">m_target</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># fill states related to `hint_mpo`</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;average bond dimension of hint mpo: </span><span class="si">{hint_mpo.bond_dims_mean}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="c1"># in case of localized `self`</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_dummy_qn</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_mps</span><span class="p">:</span>
                    <span class="n">ex_state</span><span class="p">:</span> <span class="n">MatrixProduct</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">random</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mol_list</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>
                <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_mpdm</span><span class="p">:</span>
                    <span class="n">ex_state</span><span class="p">:</span> <span class="n">MatrixProduct</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_entangled_ex</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mol_list</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">assert</span> <span class="kc">False</span>
                <span class="n">ex_state</span><span class="o">.</span><span class="n">compress_config</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compress_config</span>
                <span class="n">lastone</span> <span class="o">=</span> <span class="n">ex_state</span> <span class="o">+</span> <span class="bp">self</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="n">lastone</span> <span class="o">=</span> <span class="bp">self</span>
            <span class="n">expander_list</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="s2">&quot;MatrixProduct&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">cumulated_m</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
                <span class="n">lastone</span><span class="o">.</span><span class="n">compress_config</span><span class="o">.</span><span class="n">criteria</span> <span class="o">=</span> <span class="n">CompressCriteria</span><span class="o">.</span><span class="n">fixed</span>
                <span class="n">expander_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">lastone</span><span class="p">)</span>
                <span class="n">expander</span> <span class="o">=</span> <span class="n">compressed_sum</span><span class="p">(</span><span class="n">expander_list</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">cumulated_m</span> <span class="o">==</span> <span class="n">expander</span><span class="o">.</span><span class="n">bond_dims_mean</span><span class="p">:</span>
                    <span class="c1"># probably a small system, the required bond dimension can&#39;t be reached</span>
                    <span class="k">break</span>
                <span class="n">cumulated_m</span> <span class="o">=</span> <span class="n">expander</span><span class="o">.</span><span class="n">bond_dims_mean</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;cumulated bond dimension: </span><span class="si">{cumulated_m}</span><span class="s2">. lastone bond dimension: </span><span class="si">{lastone.bond_dims}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">m_target</span> <span class="o">&lt;</span> <span class="n">cumulated_m</span><span class="p">:</span>
                    <span class="k">break</span>
                <span class="k">if</span> <span class="n">m_target</span> <span class="o">&lt;</span> <span class="mf">0.8</span> <span class="o">*</span> <span class="p">(</span><span class="n">lastone</span><span class="o">.</span><span class="n">bond_dims_mean</span> <span class="o">*</span> <span class="n">hint_mpo</span><span class="o">.</span><span class="n">bond_dims_mean</span><span class="p">):</span>
                    <span class="n">lastone</span> <span class="o">=</span> <span class="n">lastone</span><span class="o">.</span><span class="n">canonicalise</span><span class="p">()</span><span class="o">.</span><span class="n">compress</span><span class="p">(</span><span class="n">m_target</span> <span class="o">//</span> <span class="n">hint_mpo</span><span class="o">.</span><span class="n">bond_dims_mean</span><span class="p">)</span>
                <span class="n">lastone</span> <span class="o">=</span> <span class="n">hint_mpo</span> <span class="o">@</span> <span class="n">lastone</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;expander bond dimension: </span><span class="si">{expander.bond_dims}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">orig_config</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">compress_config</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compress_config</span><span class="p">,</span> <span class="n">expander</span><span class="o">.</span><span class="n">compress_config</span>
        <span class="c1"># final compression</span>
        <span class="n">res</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span> <span class="o">+</span> <span class="n">expander</span><span class="o">.</span><span class="n">scale</span><span class="p">(</span><span class="n">coef</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span><span class="o">.</span><span class="n">canonicalise</span><span class="p">()</span><span class="o">.</span><span class="n">compress</span><span class="p">()</span><span class="o">.</span><span class="n">canonical_normalize</span><span class="p">()</span>
        <span class="n">res</span><span class="o">.</span><span class="n">compress_config</span> <span class="o">=</span> <span class="n">orig_config</span>
        <span class="k">return</span> <span class="n">res</span></div>

    <span class="k">def</span> <span class="nf">evolve</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mpo</span><span class="p">,</span> <span class="n">evolve_dt</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">hybrid_tdh</span><span class="p">:</span>
            <span class="n">hybrid_mpo</span><span class="p">,</span> <span class="n">HAM</span><span class="p">,</span> <span class="n">Etot</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">construct_hybrid_Ham</span><span class="p">(</span><span class="n">mpo</span><span class="p">)</span>
            <span class="n">mps</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">evolve_dmrg</span><span class="p">(</span><span class="n">hybrid_mpo</span><span class="p">,</span> <span class="n">evolve_dt</span><span class="p">)</span>
            <span class="n">unitary_propagation</span><span class="p">(</span><span class="n">mps</span><span class="o">.</span><span class="n">tdh_wfns</span><span class="p">,</span> <span class="n">HAM</span><span class="p">,</span> <span class="n">Etot</span><span class="p">,</span> <span class="n">evolve_dt</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># save the cost of calculating energy</span>
            <span class="n">mps</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">evolve_dmrg</span><span class="p">(</span><span class="n">mpo</span><span class="p">,</span> <span class="n">evolve_dt</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">iscomplex</span><span class="p">(</span><span class="n">evolve_dt</span><span class="p">):</span>
            <span class="n">mps</span><span class="o">.</span><span class="n">normalize</span><span class="p">(</span><span class="mf">1.0</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">mps</span><span class="o">.</span><span class="n">normalize</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">mps</span>

    <span class="k">def</span> <span class="nf">evolve_dmrg</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mpo</span><span class="p">,</span> <span class="n">evolve_dt</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;Mps&quot;</span><span class="p">:</span>

        <span class="n">method</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">EvolveMethod</span><span class="o">.</span><span class="n">prop_and_compress</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_evolve_dmrg_prop_and_compress</span><span class="p">,</span>
            <span class="n">EvolveMethod</span><span class="o">.</span><span class="n">tdvp_mu_vmf</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_evolve_dmrg_tdvp_mu_vmf</span><span class="p">,</span>
            <span class="n">EvolveMethod</span><span class="o">.</span><span class="n">tdvp_vmf</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_evolve_dmrg_tdvp_vmf</span><span class="p">,</span>
            <span class="n">EvolveMethod</span><span class="o">.</span><span class="n">tdvp_mu_cmf</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_evolve_dmrg_tdvp_mu_cmf</span><span class="p">,</span>
            <span class="n">EvolveMethod</span><span class="o">.</span><span class="n">tdvp_ps</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_evolve_dmrg_tdvp_ps</span><span class="p">,</span>
        <span class="p">}[</span><span class="bp">self</span><span class="o">.</span><span class="n">evolve_config</span><span class="o">.</span><span class="n">method</span><span class="p">]</span>
        <span class="n">new_mps</span> <span class="o">=</span> <span class="n">method</span><span class="p">(</span><span class="n">mpo</span><span class="p">,</span> <span class="n">evolve_dt</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">new_mps</span>

    <span class="k">def</span> <span class="nf">_evolve_dmrg_prop_and_compress</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mpo</span><span class="p">,</span> <span class="n">evolve_dt</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;Mps&quot;</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        The global propagation &amp; compression evolution scheme</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">config</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">evolve_config</span>
        <span class="k">assert</span> <span class="n">evolve_dt</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>

        <span class="n">propagation_c</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">rk_config</span><span class="o">.</span><span class="n">coeff</span>
        <span class="n">termlist</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="p">]</span>
        <span class="c1"># don&#39;t let bond dim grow when contracting</span>
        <span class="n">orig_compress_config</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compress_config</span>
        <span class="n">contract_compress_config</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compress_config</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">contract_compress_config</span><span class="o">.</span><span class="n">criteria</span> <span class="ow">is</span> <span class="n">CompressCriteria</span><span class="o">.</span><span class="n">threshold</span><span class="p">:</span>
            <span class="n">contract_compress_config</span><span class="o">.</span><span class="n">criteria</span> <span class="o">=</span> <span class="n">CompressCriteria</span><span class="o">.</span><span class="n">both</span>
        <span class="c1">#contract_compress_config.min_dims = None</span>
        <span class="c1">#contract_compress_config.max_dims = np.array(self.bond_dims) + 4</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">compress_config</span> <span class="o">=</span> <span class="n">contract_compress_config</span>

        <span class="k">while</span> <span class="nb">len</span><span class="p">(</span><span class="n">termlist</span><span class="p">)</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">propagation_c</span><span class="p">):</span>
            <span class="n">termlist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">mpo</span><span class="o">.</span><span class="n">contract</span><span class="p">(</span><span class="n">termlist</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]))</span>
        <span class="c1"># bond dim can grow after adding</span>
        <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">termlist</span><span class="p">:</span>
            <span class="n">t</span><span class="o">.</span><span class="n">compress_config</span> <span class="o">=</span> <span class="n">orig_compress_config</span>

        <span class="k">if</span> <span class="n">config</span><span class="o">.</span><span class="n">adaptive</span><span class="p">:</span>
            <span class="n">config</span><span class="o">.</span><span class="n">check_valid_dt</span><span class="p">(</span><span class="n">evolve_dt</span><span class="p">)</span>
            
            <span class="n">p_restart</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="c1"># restart threshold </span>
            <span class="n">p_min</span> <span class="o">=</span> <span class="mf">0.1</span>     <span class="c1"># safeguard for minimal allowed p</span>
            <span class="n">p_max</span> <span class="o">=</span> <span class="mf">2.</span>      <span class="c1"># safeguard for maximal allowed p</span>
            
            <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
                <span class="n">scaled_termlist</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="n">dt</span> <span class="o">=</span> <span class="n">min_abs</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">guess_dt</span><span class="p">,</span> <span class="n">evolve_dt</span><span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                        <span class="n">f</span><span class="s2">&quot;guess_dt: </span><span class="si">{config.guess_dt}</span><span class="s2">, try time step size: </span><span class="si">{dt}</span><span class="s2">&quot;</span>
                <span class="p">)</span>
                <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">term</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">termlist</span><span class="p">):</span>
                    <span class="n">scale</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="mf">1.0</span><span class="n">j</span> <span class="o">*</span> <span class="n">dt</span><span class="p">)</span> <span class="o">**</span> <span class="n">idx</span> <span class="o">*</span> <span class="n">propagation_c</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
                    <span class="n">scaled_termlist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">term</span><span class="o">.</span><span class="n">scale</span><span class="p">(</span><span class="n">scale</span><span class="p">))</span>
                <span class="k">del</span> <span class="n">term</span>
                <span class="n">new_mps1</span> <span class="o">=</span> <span class="n">compressed_sum</span><span class="p">(</span><span class="n">scaled_termlist</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span><span class="o">.</span><span class="n">_dmrg_normalize</span><span class="p">()</span>
                <span class="n">new_mps2</span> <span class="o">=</span> <span class="n">compressed_sum</span><span class="p">([</span><span class="n">new_mps1</span><span class="p">,</span> <span class="n">scaled_termlist</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]])</span><span class="o">.</span><span class="n">_dmrg_normalize</span><span class="p">()</span>
                <span class="n">dis</span> <span class="o">=</span> <span class="n">new_mps1</span><span class="o">.</span><span class="n">distance</span><span class="p">(</span><span class="n">new_mps2</span><span class="p">)</span>
                <span class="c1"># 0.2 is 1/5 for RK45</span>
                <span class="n">p</span> <span class="o">=</span> <span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">adaptive_rtol</span> <span class="o">/</span> <span class="p">(</span><span class="n">dis</span> <span class="o">+</span> <span class="mf">1e-30</span><span class="p">))</span> <span class="o">**</span> <span class="mf">0.2</span>    
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;RK45 error distance: </span><span class="si">{dis}</span><span class="s2">, enlarge p parameter: </span><span class="si">{p}</span><span class="s2">&quot;</span><span class="p">)</span>
                
                <span class="k">if</span> <span class="n">xp</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">dt</span><span class="p">,</span> <span class="n">evolve_dt</span><span class="p">):</span>
                    <span class="c1"># approahes the end </span>
                    <span class="k">if</span> <span class="n">p</span> <span class="o">&lt;</span> <span class="n">p_restart</span><span class="p">:</span>
                        <span class="c1"># not accurate in this final sub-step will restart</span>
                        <span class="n">config</span><span class="o">.</span><span class="n">guess_dt</span> <span class="o">=</span> <span class="n">dt</span> <span class="o">*</span> <span class="nb">max</span><span class="p">(</span><span class="n">p_min</span><span class="p">,</span> <span class="n">p</span><span class="p">)</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                            <span class="n">f</span><span class="s2">&quot;evolution not converged, new guess_dt: </span><span class="si">{config.guess_dt}</span><span class="s2">&quot;</span>
                        <span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="c1"># normal exit</span>
                        <span class="n">new_mps2</span><span class="o">.</span><span class="n">evolve_config</span><span class="o">.</span><span class="n">guess_dt</span> <span class="o">=</span> <span class="n">min_abs</span><span class="p">(</span><span class="n">dt</span><span class="o">*</span><span class="n">p</span><span class="p">,</span> <span class="n">config</span><span class="o">.</span><span class="n">guess_dt</span><span class="p">)</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                            <span class="n">f</span><span class="s2">&quot;evolution converged, new guess_dt: </span><span class="si">{new_mps2.evolve_config.guess_dt}</span><span class="s2">&quot;</span>
                        <span class="p">)</span>
                        <span class="k">return</span> <span class="n">new_mps2</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># sub-steps </span>
                    <span class="k">if</span> <span class="n">p</span> <span class="o">&lt;</span> <span class="n">p_restart</span><span class="p">:</span>
                        <span class="n">config</span><span class="o">.</span><span class="n">guess_dt</span> <span class="o">*=</span> <span class="nb">max</span><span class="p">(</span><span class="n">p_min</span><span class="p">,</span> <span class="n">p</span><span class="p">)</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                            <span class="n">f</span><span class="s2">&quot;evolution not converged, new guess_dt: </span><span class="si">{config.guess_dt}</span><span class="s2">&quot;</span>
                        <span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">new_dt</span> <span class="o">=</span> <span class="n">evolve_dt</span> <span class="o">-</span> <span class="n">dt</span>
                        <span class="n">config</span><span class="o">.</span><span class="n">guess_dt</span> <span class="o">*=</span> <span class="nb">min</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">p_max</span><span class="p">)</span> 
                        <span class="n">new_mps2</span><span class="o">.</span><span class="n">evolve_config</span><span class="o">.</span><span class="n">guess_dt</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">guess_dt</span>
                        <span class="k">del</span> <span class="n">new_mps1</span><span class="p">,</span> <span class="n">termlist</span><span class="p">,</span> <span class="n">scaled_termlist</span>  <span class="c1"># memory consuming and not useful anymore</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                            <span class="n">f</span><span class="s2">&quot;evolution converged, new guess_dt: </span><span class="si">{config.guess_dt}</span><span class="s2">&quot;</span>
                        <span class="p">)</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;sub-step </span><span class="si">{dt}</span><span class="s2"> further, remaining: </span><span class="si">{new_dt}</span><span class="s2">&quot;</span><span class="p">)</span>
                        <span class="k">return</span> <span class="n">new_mps2</span><span class="o">.</span><span class="n">_evolve_dmrg_prop_and_compress</span><span class="p">(</span><span class="n">mpo</span><span class="p">,</span> <span class="n">new_dt</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">term</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">termlist</span><span class="p">):</span>
                <span class="n">term</span><span class="o">.</span><span class="n">scale</span><span class="p">(</span>
                    <span class="p">(</span><span class="o">-</span><span class="mf">1.0</span><span class="n">j</span> <span class="o">*</span> <span class="n">evolve_dt</span><span class="p">)</span> <span class="o">**</span> <span class="n">idx</span> <span class="o">*</span> <span class="n">propagation_c</span><span class="p">[</span><span class="n">idx</span><span class="p">],</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span>
                <span class="p">)</span>
            <span class="k">return</span> <span class="n">compressed_sum</span><span class="p">(</span><span class="n">termlist</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_evolve_dmrg_tdvp_vmf</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mpo</span><span class="p">,</span> <span class="n">evolve_dt</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;Mps&quot;</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        variable mean field</span>
<span class="sd">        see the difference between VMF and CMF, refer to Z. Phys. D 42, 113129 (1997)</span>
<span class="sd">        only the RKF45 integration is used.</span>
<span class="sd">        The default RKF45 local step error tolerance is rtol:1e-5, atol:1e-8</span>
<span class="sd">        regulation of S is 1e-10, these default parameters could be changed in</span>
<span class="sd">        /utils/configs.py</span>

<span class="sd">        &quot;&quot;&quot;</span>
        
        <span class="c1"># a workaround for https://github.com/scipy/scipy/issues/10164</span>
        <span class="n">imag_time</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">iscomplex</span><span class="p">(</span><span class="n">evolve_dt</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">imag_time</span><span class="p">:</span>
            <span class="n">evolve_dt</span> <span class="o">=</span> <span class="o">-</span><span class="n">evolve_dt</span><span class="o">.</span><span class="n">imag</span>
            <span class="c1"># used in calculating derivatives</span>
            <span class="n">coef</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">coef</span> <span class="o">=</span> <span class="mi">1</span><span class="n">j</span>
        
        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">evolve_config</span><span class="o">.</span><span class="n">force_ovlp</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">to_right</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ensure_left_canon</span><span class="p">()</span>
        
        <span class="c1"># `self` should not be modified during the evolution</span>
        <span class="k">if</span> <span class="n">imag_time</span><span class="p">:</span>
            <span class="n">mps</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">mps</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">to_complex</span><span class="p">()</span>

        <span class="n">w_min_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">def</span> <span class="nf">func_vmf</span><span class="p">(</span><span class="n">t</span><span class="p">,</span><span class="n">y</span><span class="p">):</span>
            
            <span class="n">w_min_list</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
            <span class="c1"># update mps: from left to right</span>
            <span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">for</span> <span class="n">imps</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">mps</span><span class="o">.</span><span class="n">site_num</span><span class="p">):</span>
                <span class="n">mps</span><span class="p">[</span><span class="n">imps</span><span class="p">]</span> <span class="o">=</span> <span class="n">y</span><span class="p">[</span><span class="n">offset</span><span class="p">:</span><span class="n">offset</span><span class="o">+</span><span class="n">mps</span><span class="p">[</span><span class="n">imps</span><span class="p">]</span><span class="o">.</span><span class="n">size</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">mps</span><span class="p">[</span><span class="n">imps</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
                <span class="n">offset</span> <span class="o">+=</span> <span class="n">mps</span><span class="p">[</span><span class="n">imps</span><span class="p">]</span><span class="o">.</span><span class="n">size</span>
            
            <span class="n">mps_conj</span> <span class="o">=</span> <span class="n">mps</span><span class="o">.</span><span class="n">conj</span><span class="p">()</span>

            <span class="n">environ</span> <span class="o">=</span> <span class="n">Environ</span><span class="p">(</span><span class="n">mps</span><span class="p">,</span> <span class="n">mpo</span><span class="p">,</span> <span class="s2">&quot;L&quot;</span><span class="p">)</span>
            <span class="n">environ</span><span class="o">.</span><span class="n">write_r_sentinel</span><span class="p">(</span><span class="n">mps</span><span class="p">)</span>

            <span class="c1"># the first S_R</span>
            <span class="n">S_R</span> <span class="o">=</span> <span class="n">ones</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">mps</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
            
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">evolve_config</span><span class="o">.</span><span class="n">force_ovlp</span><span class="p">:</span>
                <span class="c1"># construct the S_L list (type: Matrix) and S_L_inv list (type: xp.array)</span>
                <span class="c1"># len: mps.site_num+1</span>
                <span class="n">S_L_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">ones</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">mps</span><span class="o">.</span><span class="n">dtype</span><span class="p">),]</span>
                <span class="k">for</span> <span class="n">imps</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">mps</span><span class="o">.</span><span class="n">site_num</span><span class="p">):</span>
                    <span class="n">S_L_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">transferMat</span><span class="p">(</span><span class="n">mps</span><span class="p">,</span> <span class="n">mps_conj</span><span class="p">,</span> <span class="s2">&quot;L&quot;</span><span class="p">,</span> <span class="n">imps</span><span class="p">,</span>
                        <span class="n">S_L_list</span><span class="p">[</span><span class="n">imps</span><span class="p">]))</span>
                
                <span class="n">S_L_inv_list</span> <span class="o">=</span> <span class="p">[]</span>    
                <span class="k">for</span> <span class="n">imps</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">mps</span><span class="o">.</span><span class="n">site_num</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
                    <span class="n">w</span><span class="p">,</span> <span class="n">u</span> <span class="o">=</span> <span class="n">scipy</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">eigh</span><span class="p">(</span><span class="n">S_L_list</span><span class="p">[</span><span class="n">imps</span><span class="p">]</span><span class="o">.</span><span class="n">asnumpy</span><span class="p">())</span>
                    <span class="n">S_L_inv</span> <span class="o">=</span> <span class="n">xp</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="mf">1.0</span> <span class="o">/</span> <span class="n">w</span><span class="p">))</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">conj</span><span class="p">()))</span>
                    <span class="n">S_L_inv_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">S_L_inv</span><span class="p">)</span>
                    <span class="n">S_L_list</span><span class="p">[</span><span class="n">imps</span><span class="p">]</span> <span class="o">=</span> <span class="n">S_L_list</span><span class="p">[</span><span class="n">imps</span><span class="p">]</span><span class="o">.</span><span class="n">array</span>
                
            <span class="k">else</span><span class="p">:</span>
                <span class="n">S_L_list</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">,]</span> <span class="o">*</span> <span class="p">(</span><span class="n">mps</span><span class="o">.</span><span class="n">site_num</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
                <span class="n">S_L_inv_list</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">,]</span> <span class="o">*</span> <span class="p">(</span><span class="n">mps</span><span class="o">.</span><span class="n">site_num</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>

            <span class="c1"># calculate hop_y: from right to left</span>
            <span class="n">hop_y</span> <span class="o">=</span> <span class="n">xp</span><span class="o">.</span><span class="n">empty_like</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
            
            <span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">for</span> <span class="n">imps</span> <span class="ow">in</span> <span class="n">mps</span><span class="o">.</span><span class="n">iter_idx_list</span><span class="p">(</span><span class="n">full</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
                <span class="n">shape</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">mps</span><span class="p">[</span><span class="n">imps</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
                <span class="n">ltensor</span> <span class="o">=</span> <span class="n">environ</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="s2">&quot;L&quot;</span><span class="p">,</span> <span class="n">imps</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
                
                <span class="k">if</span> <span class="n">imps</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">site_num</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="c1"># the coefficient site</span>
                    <span class="n">rtensor</span> <span class="o">=</span> <span class="n">ones</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
                    <span class="n">hop</span> <span class="o">=</span> <span class="n">hop_factory</span><span class="p">(</span><span class="n">ltensor</span><span class="p">,</span> <span class="n">rtensor</span><span class="p">,</span> <span class="n">mpo</span><span class="p">[</span><span class="n">imps</span><span class="p">],</span> <span class="nb">len</span><span class="p">(</span><span class="n">shape</span><span class="p">))</span>
                    <span class="n">S_inv</span> <span class="o">=</span> <span class="n">xp</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">xp</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">dtype</span><span class="o">=</span><span class="n">mps</span><span class="o">.</span><span class="n">dtype</span><span class="p">))</span>
                    <span class="n">func</span> <span class="o">=</span> <span class="n">integrand_func_factory</span><span class="p">(</span><span class="n">shape</span><span class="p">,</span> <span class="n">hop</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="n">S_inv</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span>
                            <span class="n">coef</span><span class="p">,</span> <span class="n">Ovlp_inv1</span><span class="o">=</span><span class="n">S_L_inv_list</span><span class="p">[</span><span class="n">imps</span><span class="o">+</span><span class="mi">1</span><span class="p">],</span>
                            <span class="n">Ovlp_inv0</span><span class="o">=</span><span class="n">S_L_inv_list</span><span class="p">[</span><span class="n">imps</span><span class="p">],</span> <span class="n">Ovlp0</span><span class="o">=</span><span class="n">S_L_list</span><span class="p">[</span><span class="n">imps</span><span class="p">])</span>
                               
                    <span class="n">hop_y</span><span class="p">[</span><span class="n">offset</span><span class="o">-</span><span class="n">mps</span><span class="p">[</span><span class="n">imps</span><span class="p">]</span><span class="o">.</span><span class="n">size</span><span class="p">:]</span> <span class="o">=</span> <span class="n">func</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">mps</span><span class="p">[</span><span class="n">imps</span><span class="p">]</span><span class="o">.</span><span class="n">array</span><span class="o">.</span><span class="n">ravel</span><span class="p">())</span>
                    <span class="n">offset</span> <span class="o">-=</span> <span class="n">mps</span><span class="p">[</span><span class="n">imps</span><span class="p">]</span><span class="o">.</span><span class="n">size</span>

                    <span class="k">continue</span>
                
                <span class="n">rtensor</span> <span class="o">=</span> <span class="n">environ</span><span class="o">.</span><span class="n">GetLR</span><span class="p">(</span>
                    <span class="s2">&quot;R&quot;</span><span class="p">,</span> <span class="n">imps</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">mps</span><span class="p">,</span> <span class="n">mpo</span><span class="p">,</span> <span class="n">itensor</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s2">&quot;System&quot;</span><span class="p">)</span>
                
                <span class="c1"># regularize density matrix</span>
                <span class="c1"># Note that S_R is (#.conj, #)</span>
                <span class="n">S_R</span> <span class="o">=</span> <span class="n">transferMat</span><span class="p">(</span><span class="n">mps</span><span class="p">,</span> <span class="n">mps_conj</span><span class="p">,</span> <span class="s2">&quot;R&quot;</span><span class="p">,</span> <span class="n">imps</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">Matrix</span><span class="p">(</span><span class="n">S_R</span><span class="p">))</span><span class="o">.</span><span class="n">asnumpy</span><span class="p">()</span>
                <span class="n">w</span><span class="p">,</span> <span class="n">u</span> <span class="o">=</span> <span class="n">scipy</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">eigh</span><span class="p">(</span><span class="n">S_R</span><span class="p">)</span>
                
                <span class="c1"># discard the negative eigenvalues due to numerical error</span>
                <span class="n">w</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">w</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
                
                <span class="n">w_min_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">w</span><span class="o">.</span><span class="n">min</span><span class="p">())</span>

                <span class="n">epsilon</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">evolve_config</span><span class="o">.</span><span class="n">reg_epsilon</span>
                <span class="n">w</span> <span class="o">=</span> <span class="n">w</span> <span class="o">+</span> <span class="n">epsilon</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">w</span> <span class="o">/</span> <span class="n">epsilon</span><span class="p">)</span>
                
                <span class="c1"># S_inv is (#.conj, #)</span>
                <span class="n">S_inv</span> <span class="o">=</span> <span class="n">xp</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="mf">1.0</span> <span class="o">/</span> <span class="n">w</span><span class="p">))</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">conj</span><span class="p">()))</span><span class="o">.</span><span class="n">T</span>

                <span class="n">hop</span> <span class="o">=</span> <span class="n">hop_factory</span><span class="p">(</span><span class="n">ltensor</span><span class="p">,</span> <span class="n">rtensor</span><span class="p">,</span> <span class="n">mpo</span><span class="p">[</span><span class="n">imps</span><span class="p">],</span> <span class="nb">len</span><span class="p">(</span><span class="n">shape</span><span class="p">))</span>
                
                <span class="n">func</span> <span class="o">=</span> <span class="n">integrand_func_factory</span><span class="p">(</span><span class="n">shape</span><span class="p">,</span> <span class="n">hop</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="n">S_inv</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span>
                        <span class="n">coef</span><span class="p">,</span> <span class="n">Ovlp_inv1</span><span class="o">=</span><span class="n">S_L_inv_list</span><span class="p">[</span><span class="n">imps</span><span class="o">+</span><span class="mi">1</span><span class="p">],</span>
                        <span class="n">Ovlp_inv0</span><span class="o">=</span><span class="n">S_L_inv_list</span><span class="p">[</span><span class="n">imps</span><span class="p">],</span> <span class="n">Ovlp0</span><span class="o">=</span><span class="n">S_L_list</span><span class="p">[</span><span class="n">imps</span><span class="p">])</span>

                <span class="n">hop_y</span><span class="p">[</span><span class="n">offset</span><span class="o">-</span><span class="n">mps</span><span class="p">[</span><span class="n">imps</span><span class="p">]</span><span class="o">.</span><span class="n">size</span><span class="p">:</span><span class="n">offset</span><span class="p">]</span> <span class="o">=</span> <span class="n">func</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">mps</span><span class="p">[</span><span class="n">imps</span><span class="p">]</span><span class="o">.</span><span class="n">array</span><span class="o">.</span><span class="n">ravel</span><span class="p">())</span>
                <span class="n">offset</span> <span class="o">-=</span> <span class="n">mps</span><span class="p">[</span><span class="n">imps</span><span class="p">]</span><span class="o">.</span><span class="n">size</span>
            
            <span class="k">return</span> <span class="n">hop_y</span>
        
        <span class="n">init_y</span> <span class="o">=</span> <span class="n">xp</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">ms</span><span class="o">.</span><span class="n">array</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span> <span class="k">for</span> <span class="n">ms</span> <span class="ow">in</span> <span class="n">mps</span><span class="p">])</span>
        <span class="c1"># the ivp local error, please refer to the Scipy default setting</span>
        <span class="n">sol</span> <span class="o">=</span> <span class="n">solve_ivp</span><span class="p">(</span> <span class="n">func_vmf</span><span class="p">,</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">evolve_dt</span><span class="p">),</span> <span class="n">init_y</span><span class="p">,</span>
                <span class="n">method</span><span class="o">=</span><span class="s2">&quot;RK45&quot;</span><span class="p">,</span>
                <span class="n">rtol</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">evolve_config</span><span class="o">.</span><span class="n">ivp_rtol</span><span class="p">,</span>
                <span class="n">atol</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">evolve_config</span><span class="o">.</span><span class="n">ivp_atol</span><span class="p">)</span>
        
        <span class="c1"># update mps: from left to right</span>
        <span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">imps</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">mps</span><span class="o">.</span><span class="n">site_num</span><span class="p">):</span>
            <span class="n">mps</span><span class="p">[</span><span class="n">imps</span><span class="p">]</span> <span class="o">=</span> <span class="n">sol</span><span class="o">.</span><span class="n">y</span><span class="p">[:,</span> <span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="n">offset</span><span class="p">:</span><span class="n">offset</span><span class="o">+</span><span class="n">mps</span><span class="p">[</span><span class="n">imps</span><span class="p">]</span><span class="o">.</span><span class="n">size</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">mps</span><span class="p">[</span><span class="n">imps</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
            <span class="n">offset</span> <span class="o">+=</span> <span class="n">mps</span><span class="p">[</span><span class="n">imps</span><span class="p">]</span><span class="o">.</span><span class="n">size</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;</span><span class="si">{self.evolve_config.method}</span><span class="s2"> VMF func called: </span><span class="si">{sol.nfev}</span><span class="s2">. RKF steps: {len(sol.t)}&quot;</span><span class="p">)</span>
        
        <span class="c1"># switch to tdvp_mu_vmf</span>
        <span class="n">w_min_list</span> <span class="o">=</span> <span class="n">xp</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">w_min_list</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">w_min_list</span><span class="o">.</span><span class="n">min</span><span class="p">()</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">evolve_config</span><span class="o">.</span><span class="n">reg_epsilon</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">evolve_config</span><span class="o">.</span><span class="n">vmf_auto_switch</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;w.min={w_min_list.min()}, Switch to tdvp_mu_vmf&quot;</span><span class="p">)</span>
            <span class="n">mps</span><span class="o">.</span><span class="n">evolve_config</span><span class="o">.</span><span class="n">method</span> <span class="o">=</span>  <span class="n">EvolveMethod</span><span class="o">.</span><span class="n">tdvp_mu_vmf</span>

        <span class="k">return</span> <span class="n">mps</span>

    <span class="k">def</span> <span class="nf">_evolve_dmrg_tdvp_mu_vmf</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mpo</span><span class="p">,</span> <span class="n">evolve_dt</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;Mps&quot;</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        variable mean field combined with matrix unfolding technique</span>
<span class="sd">        see the difference between VMF and CMF, refer to Z. Phys. D 42, 113129 (1997)</span>
<span class="sd">        only the RKF45 integration is used.</span>
<span class="sd">        The default RKF45 local step error tolerance is rtol:1e-5, atol:1e-8</span>
<span class="sd">        regulation of S is 1e-10, these default parameters could be changed in</span>
<span class="sd">        /utils/configs.py</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># a workaround for https://github.com/scipy/scipy/issues/10164</span>
        <span class="n">imag_time</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">iscomplex</span><span class="p">(</span><span class="n">evolve_dt</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">imag_time</span><span class="p">:</span>
            <span class="n">evolve_dt</span> <span class="o">=</span> <span class="o">-</span><span class="n">evolve_dt</span><span class="o">.</span><span class="n">imag</span>
            <span class="c1"># used in calculating derivatives</span>
            <span class="n">coef</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">coef</span> <span class="o">=</span> <span class="mi">1</span><span class="n">j</span>
        
        <span class="c1"># only not canonicalise when force_ovlp=True and to_right=False</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">evolve_config</span><span class="o">.</span><span class="n">force_ovlp</span> <span class="o">==</span> <span class="kc">True</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">to_right</span> <span class="o">==</span> <span class="kc">False</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ensure_left_canon</span><span class="p">()</span>

        <span class="c1"># `self` should not be modified during the evolution</span>
        <span class="k">if</span> <span class="n">imag_time</span><span class="p">:</span>
            <span class="n">mps</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">mps</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">to_complex</span><span class="p">()</span>
        
        <span class="n">s_min_list</span> <span class="o">=</span> <span class="p">[]</span>
        
        <span class="k">def</span> <span class="nf">func_vmf</span><span class="p">(</span><span class="n">t</span><span class="p">,</span><span class="n">y</span><span class="p">):</span>
            
            <span class="n">s_min_list</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>

            <span class="c1"># update mps: from left to right</span>
            <span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">for</span> <span class="n">imps</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">mps</span><span class="o">.</span><span class="n">site_num</span><span class="p">):</span>
                <span class="n">mps</span><span class="p">[</span><span class="n">imps</span><span class="p">]</span> <span class="o">=</span> <span class="n">y</span><span class="p">[</span><span class="n">offset</span><span class="p">:</span><span class="n">offset</span><span class="o">+</span><span class="n">mps</span><span class="p">[</span><span class="n">imps</span><span class="p">]</span><span class="o">.</span><span class="n">size</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">mps</span><span class="p">[</span><span class="n">imps</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
                <span class="n">offset</span> <span class="o">+=</span> <span class="n">mps</span><span class="p">[</span><span class="n">imps</span><span class="p">]</span><span class="o">.</span><span class="n">size</span>
            
            <span class="n">environ_mps</span> <span class="o">=</span> <span class="n">mps</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="n">environ</span> <span class="o">=</span> <span class="n">Environ</span><span class="p">(</span><span class="n">environ_mps</span><span class="p">,</span> <span class="n">mpo</span><span class="p">,</span> <span class="s2">&quot;L&quot;</span><span class="p">)</span>
            <span class="n">environ</span><span class="o">.</span><span class="n">write_r_sentinel</span><span class="p">(</span><span class="n">environ_mps</span><span class="p">)</span>
            
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">evolve_config</span><span class="o">.</span><span class="n">force_ovlp</span><span class="p">:</span>
                <span class="c1"># construct the S_L list (type: Matrix) and S_L_inv list (type: xp.array)</span>
                <span class="c1"># len: mps.site_num+1</span>
                <span class="n">S_L_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">ones</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">mps</span><span class="o">.</span><span class="n">dtype</span><span class="p">),]</span>
                <span class="k">for</span> <span class="n">imps</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">mps</span><span class="o">.</span><span class="n">site_num</span><span class="p">):</span>
                    <span class="n">S_L_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">transferMat</span><span class="p">(</span><span class="n">mps</span><span class="p">,</span> <span class="n">mps</span><span class="o">.</span><span class="n">conj</span><span class="p">(),</span> <span class="s2">&quot;L&quot;</span><span class="p">,</span> <span class="n">imps</span><span class="p">,</span>
                        <span class="n">S_L_list</span><span class="p">[</span><span class="n">imps</span><span class="p">]))</span>
                
                <span class="n">S_L_inv_list</span> <span class="o">=</span> <span class="p">[]</span>    
                <span class="k">for</span> <span class="n">imps</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">mps</span><span class="o">.</span><span class="n">site_num</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
                    <span class="n">w</span><span class="p">,</span> <span class="n">u</span> <span class="o">=</span> <span class="n">scipy</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">eigh</span><span class="p">(</span><span class="n">S_L_list</span><span class="p">[</span><span class="n">imps</span><span class="p">]</span><span class="o">.</span><span class="n">asnumpy</span><span class="p">())</span>
                    <span class="n">S_L_inv</span> <span class="o">=</span> <span class="n">xp</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="mf">1.0</span> <span class="o">/</span> <span class="n">w</span><span class="p">))</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">conj</span><span class="p">()))</span>
                    <span class="n">S_L_inv_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">S_L_inv</span><span class="p">)</span>
                    <span class="n">S_L_list</span><span class="p">[</span><span class="n">imps</span><span class="p">]</span> <span class="o">=</span> <span class="n">S_L_list</span><span class="p">[</span><span class="n">imps</span><span class="p">]</span><span class="o">.</span><span class="n">array</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">S_L_list</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">,]</span> <span class="o">*</span> <span class="p">(</span><span class="n">mps</span><span class="o">.</span><span class="n">site_num</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
                <span class="n">S_L_inv_list</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">,]</span> <span class="o">*</span> <span class="p">(</span><span class="n">mps</span><span class="o">.</span><span class="n">site_num</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
            
            <span class="c1"># calculate hop_y: from right to left</span>
            <span class="n">hop_y</span> <span class="o">=</span> <span class="n">xp</span><span class="o">.</span><span class="n">empty_like</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>

            <span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">for</span> <span class="n">imps</span> <span class="ow">in</span> <span class="n">mps</span><span class="o">.</span><span class="n">iter_idx_list</span><span class="p">(</span><span class="n">full</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
                <span class="n">shape</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">mps</span><span class="p">[</span><span class="n">imps</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
                <span class="n">ltensor</span> <span class="o">=</span> <span class="n">environ</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="s2">&quot;L&quot;</span><span class="p">,</span> <span class="n">imps</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
                
                <span class="k">if</span> <span class="n">imps</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">site_num</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="c1"># the coefficient site</span>
                    <span class="n">rtensor</span> <span class="o">=</span> <span class="n">ones</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
                    <span class="n">hop</span> <span class="o">=</span> <span class="n">hop_factory</span><span class="p">(</span><span class="n">ltensor</span><span class="p">,</span> <span class="n">rtensor</span><span class="p">,</span> <span class="n">mpo</span><span class="p">[</span><span class="n">imps</span><span class="p">],</span> <span class="nb">len</span><span class="p">(</span><span class="n">shape</span><span class="p">))</span>
                    
                    <span class="n">S_inv</span> <span class="o">=</span> <span class="n">xp</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">xp</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">dtype</span><span class="o">=</span><span class="n">mps</span><span class="o">.</span><span class="n">dtype</span><span class="p">))</span>
                    <span class="n">func</span> <span class="o">=</span> <span class="n">integrand_func_factory</span><span class="p">(</span><span class="n">shape</span><span class="p">,</span> <span class="n">hop</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="n">S_inv</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span>
                            <span class="n">coef</span><span class="p">,</span> <span class="n">Ovlp_inv1</span><span class="o">=</span><span class="n">S_L_inv_list</span><span class="p">[</span><span class="n">imps</span><span class="o">+</span><span class="mi">1</span><span class="p">],</span>
                            <span class="n">Ovlp_inv0</span><span class="o">=</span><span class="n">S_L_inv_list</span><span class="p">[</span><span class="n">imps</span><span class="p">],</span> <span class="n">Ovlp0</span><span class="o">=</span><span class="n">S_L_list</span><span class="p">[</span><span class="n">imps</span><span class="p">])</span>
                               
                    <span class="n">hop_y</span><span class="p">[</span><span class="n">offset</span><span class="o">-</span><span class="n">mps</span><span class="p">[</span><span class="n">imps</span><span class="p">]</span><span class="o">.</span><span class="n">size</span><span class="p">:]</span> <span class="o">=</span> <span class="n">func</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">mps</span><span class="p">[</span><span class="n">imps</span><span class="p">]</span><span class="o">.</span><span class="n">array</span><span class="o">.</span><span class="n">ravel</span><span class="p">())</span>
                    <span class="n">offset</span> <span class="o">-=</span> <span class="n">mps</span><span class="p">[</span><span class="n">imps</span><span class="p">]</span><span class="o">.</span><span class="n">size</span>

                    <span class="k">continue</span>
                
                <span class="c1"># perform qr on the environment mps</span>
                <span class="n">qnbigl</span><span class="p">,</span> <span class="n">qnbigr</span> <span class="o">=</span> <span class="n">environ_mps</span><span class="o">.</span><span class="n">_get_big_qn</span><span class="p">(</span><span class="n">imps</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
                <span class="n">u</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">qnlset</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">qnrset</span> <span class="o">=</span> <span class="n">svd_qn</span><span class="o">.</span><span class="n">Csvd</span><span class="p">(</span>
                    <span class="n">environ_mps</span><span class="p">[</span><span class="n">imps</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">asnumpy</span><span class="p">(),</span>
                    <span class="n">qnbigl</span><span class="p">,</span>
                    <span class="n">qnbigr</span><span class="p">,</span>
                    <span class="n">environ_mps</span><span class="o">.</span><span class="n">qntot</span><span class="p">,</span>
                    <span class="n">system</span><span class="o">=</span><span class="s2">&quot;R&quot;</span><span class="p">,</span>
                    <span class="n">full_matrices</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="n">vt</span> <span class="o">=</span> <span class="n">v</span><span class="o">.</span><span class="n">T</span>

                <span class="n">environ_mps</span><span class="p">[</span><span class="n">imps</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">vt</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">environ_mps</span><span class="p">[</span><span class="n">imps</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
                
                <span class="n">rtensor</span> <span class="o">=</span> <span class="n">environ</span><span class="o">.</span><span class="n">GetLR</span><span class="p">(</span>
                    <span class="s2">&quot;R&quot;</span><span class="p">,</span> <span class="n">imps</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">environ_mps</span><span class="p">,</span> <span class="n">mpo</span><span class="p">,</span> <span class="n">itensor</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s2">&quot;System&quot;</span>
                <span class="p">)</span>
                
                <span class="n">s_min_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">min</span><span class="p">())</span>
                <span class="n">regular_s</span> <span class="o">=</span> <span class="n">_mu_regularize</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">epsilon</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">evolve_config</span><span class="o">.</span><span class="n">reg_epsilon</span><span class="p">)</span>

                <span class="n">us</span> <span class="o">=</span> <span class="n">Matrix</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">s</span><span class="p">)))</span>

                <span class="n">rtensor</span> <span class="o">=</span> <span class="n">tensordot</span><span class="p">(</span><span class="n">rtensor</span><span class="p">,</span> <span class="n">us</span><span class="p">,</span> <span class="n">axes</span><span class="o">=</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">))</span>
                
                <span class="n">environ_mps</span><span class="p">[</span><span class="n">imps</span><span class="p">]</span> <span class="o">=</span> <span class="n">tensordot</span><span class="p">(</span><span class="n">environ_mps</span><span class="p">[</span><span class="n">imps</span><span class="p">],</span> <span class="n">us</span><span class="p">,</span> <span class="n">axes</span><span class="o">=</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
                <span class="n">environ_mps</span><span class="o">.</span><span class="n">qn</span><span class="p">[</span><span class="n">imps</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">qnrset</span>
                
                <span class="n">S_inv</span> <span class="o">=</span> <span class="n">Matrix</span><span class="p">(</span><span class="n">u</span><span class="p">)</span><span class="o">.</span><span class="n">conj</span><span class="p">()</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">xp</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="mf">1.0</span> <span class="o">/</span> <span class="n">regular_s</span><span class="p">))</span><span class="o">.</span><span class="n">T</span>

                <span class="n">hop</span> <span class="o">=</span> <span class="n">hop_factory</span><span class="p">(</span><span class="n">ltensor</span><span class="p">,</span> <span class="n">rtensor</span><span class="p">,</span> <span class="n">mpo</span><span class="p">[</span><span class="n">imps</span><span class="p">],</span> <span class="nb">len</span><span class="p">(</span><span class="n">shape</span><span class="p">))</span>

                <span class="n">func</span> <span class="o">=</span> <span class="n">integrand_func_factory</span><span class="p">(</span><span class="n">shape</span><span class="p">,</span> <span class="n">hop</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="n">S_inv</span><span class="o">.</span><span class="n">array</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span>
                        <span class="n">coef</span><span class="p">,</span> <span class="n">Ovlp_inv1</span><span class="o">=</span><span class="n">S_L_inv_list</span><span class="p">[</span><span class="n">imps</span><span class="o">+</span><span class="mi">1</span><span class="p">],</span>
                        <span class="n">Ovlp_inv0</span><span class="o">=</span><span class="n">S_L_inv_list</span><span class="p">[</span><span class="n">imps</span><span class="p">],</span> <span class="n">Ovlp0</span><span class="o">=</span><span class="n">S_L_list</span><span class="p">[</span><span class="n">imps</span><span class="p">])</span>
                
                <span class="n">hop_y</span><span class="p">[</span><span class="n">offset</span><span class="o">-</span><span class="n">mps</span><span class="p">[</span><span class="n">imps</span><span class="p">]</span><span class="o">.</span><span class="n">size</span><span class="p">:</span><span class="n">offset</span><span class="p">]</span> <span class="o">=</span> <span class="n">func</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">mps</span><span class="p">[</span><span class="n">imps</span><span class="p">]</span><span class="o">.</span><span class="n">array</span><span class="o">.</span><span class="n">ravel</span><span class="p">())</span>
                <span class="n">offset</span> <span class="o">-=</span> <span class="n">mps</span><span class="p">[</span><span class="n">imps</span><span class="p">]</span><span class="o">.</span><span class="n">size</span>
            
            <span class="k">return</span> <span class="n">hop_y</span>

        <span class="n">init_y</span> <span class="o">=</span> <span class="n">xp</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">ms</span><span class="o">.</span><span class="n">array</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span> <span class="k">for</span> <span class="n">ms</span> <span class="ow">in</span> <span class="n">mps</span><span class="p">])</span>
        <span class="c1"># the ivp local error, please refer to the Scipy default setting</span>
        <span class="n">sol</span> <span class="o">=</span> <span class="n">solve_ivp</span><span class="p">(</span> <span class="n">func_vmf</span><span class="p">,</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">evolve_dt</span><span class="p">),</span> <span class="n">init_y</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s2">&quot;RK45&quot;</span><span class="p">,</span>
                <span class="n">rtol</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">evolve_config</span><span class="o">.</span><span class="n">ivp_rtol</span><span class="p">,</span>
                <span class="n">atol</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">evolve_config</span><span class="o">.</span><span class="n">ivp_atol</span><span class="p">)</span>
        
        <span class="c1"># update mps: from left to right</span>
        <span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">imps</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">mps</span><span class="o">.</span><span class="n">site_num</span><span class="p">):</span>
            <span class="n">mps</span><span class="p">[</span><span class="n">imps</span><span class="p">]</span> <span class="o">=</span> <span class="n">sol</span><span class="o">.</span><span class="n">y</span><span class="p">[:,</span> <span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="n">offset</span><span class="p">:</span><span class="n">offset</span><span class="o">+</span><span class="n">mps</span><span class="p">[</span><span class="n">imps</span><span class="p">]</span><span class="o">.</span><span class="n">size</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">mps</span><span class="p">[</span><span class="n">imps</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
            <span class="n">offset</span> <span class="o">+=</span> <span class="n">mps</span><span class="p">[</span><span class="n">imps</span><span class="p">]</span><span class="o">.</span><span class="n">size</span>
        
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;</span><span class="si">{self.evolve_config.method}</span><span class="s2"> VMF func called: </span><span class="si">{sol.nfev}</span><span class="s2">. RKF steps: {len(sol.t)}&quot;</span><span class="p">)</span>
        
        <span class="n">s_min_list</span> <span class="o">=</span> <span class="n">xp</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">s_min_list</span><span class="p">)</span>
        <span class="c1"># switch to tdvp_vmf</span>
        <span class="k">if</span> <span class="n">s_min_list</span><span class="o">.</span><span class="n">min</span><span class="p">()</span> <span class="o">&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">evolve_config</span><span class="o">.</span><span class="n">reg_epsilon</span><span class="o">*</span><span class="mf">10.</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">evolve_config</span><span class="o">.</span><span class="n">vmf_auto_switch</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;s.min={s_min_list.min()},Switch to tdvp_vmf&quot;</span><span class="p">)</span>
            <span class="n">mps</span><span class="o">.</span><span class="n">evolve_config</span><span class="o">.</span><span class="n">method</span> <span class="o">=</span>  <span class="n">EvolveMethod</span><span class="o">.</span><span class="n">tdvp_vmf</span>

        <span class="k">return</span> <span class="n">mps</span>

    <span class="nd">@adaptive_tdvp</span>
    <span class="k">def</span> <span class="nf">_evolve_dmrg_tdvp_mu_cmf</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mpo</span><span class="p">,</span> <span class="n">evolve_dt</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;Mps&quot;</span><span class="p">:</span>
        <span class="c1"># new regularization scheme</span>
        <span class="c1"># JCP 148, 124105 (2018)</span>
        <span class="c1"># JCP 149, 044119 (2018)</span>

        <span class="n">imag_time</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">iscomplex</span><span class="p">(</span><span class="n">evolve_dt</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ensure_left_canon</span><span class="p">()</span>

        <span class="c1"># `self` should not be modified during the evolution</span>
        <span class="c1"># mps: the mps to return</span>
        <span class="c1"># environ_mps: mps to construct environ</span>
        <span class="k">if</span> <span class="n">imag_time</span><span class="p">:</span>
            <span class="n">mps</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">mps</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">to_complex</span><span class="p">()</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">evolve_config</span><span class="o">.</span><span class="n">tdvp_cmf_midpoint</span><span class="p">:</span>
            <span class="c1"># mps at t/2 as environment</span>
            <span class="n">orig_config</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">evolve_config</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">evolve_config</span><span class="o">.</span><span class="n">tdvp_cmf_midpoint</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">evolve_config</span><span class="o">.</span><span class="n">adaptive</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">environ_mps</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">evolve_dmrg</span><span class="p">(</span><span class="n">mpo</span><span class="p">,</span> <span class="n">evolve_dt</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">evolve_config</span> <span class="o">=</span> <span class="n">orig_config</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># mps at t=0 as environment</span>
            <span class="n">environ_mps</span> <span class="o">=</span> <span class="n">mps</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="c1"># construct the environment matrix</span>
        <span class="n">environ</span> <span class="o">=</span> <span class="n">Environ</span><span class="p">(</span><span class="n">environ_mps</span><span class="p">,</span> <span class="n">mpo</span><span class="p">,</span> <span class="s2">&quot;L&quot;</span><span class="p">)</span>
        <span class="n">environ</span><span class="o">.</span><span class="n">write_r_sentinel</span><span class="p">(</span><span class="n">environ_mps</span><span class="p">)</span>

        <span class="c1"># a workaround for https://github.com/scipy/scipy/issues/10164</span>
        <span class="k">if</span> <span class="n">imag_time</span><span class="p">:</span>
            <span class="n">evolve_dt</span> <span class="o">=</span> <span class="o">-</span><span class="n">evolve_dt</span><span class="o">.</span><span class="n">imag</span>
            <span class="c1"># used in calculating derivatives</span>
            <span class="n">coef</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">coef</span> <span class="o">=</span> <span class="mi">1</span><span class="n">j</span>

        <span class="c1"># statistics for debug output</span>
        <span class="n">cmf_rk_steps</span> <span class="o">=</span> <span class="p">[]</span>
        
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">evolve_config</span><span class="o">.</span><span class="n">force_ovlp</span><span class="p">:</span>
            <span class="c1"># construct the S_L list (type: Matrix) and S_L_inv list (type: xp.array)</span>
            <span class="c1"># len: mps.site_num+1</span>
            <span class="n">S_L_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">ones</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">mps</span><span class="o">.</span><span class="n">dtype</span><span class="p">),]</span>
            <span class="k">for</span> <span class="n">imps</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">mps</span><span class="o">.</span><span class="n">site_num</span><span class="p">):</span>
                <span class="n">S_L_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">transferMat</span><span class="p">(</span><span class="n">environ_mps</span><span class="p">,</span> <span class="n">environ_mps</span><span class="o">.</span><span class="n">conj</span><span class="p">(),</span> <span class="s2">&quot;L&quot;</span><span class="p">,</span> <span class="n">imps</span><span class="p">,</span>
                    <span class="n">S_L_list</span><span class="p">[</span><span class="n">imps</span><span class="p">]))</span>
            
            <span class="n">S_L_inv_list</span> <span class="o">=</span> <span class="p">[]</span>    
            <span class="k">for</span> <span class="n">imps</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">mps</span><span class="o">.</span><span class="n">site_num</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
                <span class="n">w</span><span class="p">,</span> <span class="n">u</span> <span class="o">=</span> <span class="n">scipy</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">eigh</span><span class="p">(</span><span class="n">S_L_list</span><span class="p">[</span><span class="n">imps</span><span class="p">]</span><span class="o">.</span><span class="n">asnumpy</span><span class="p">())</span>
                <span class="n">S_L_inv</span> <span class="o">=</span> <span class="n">xp</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="mf">1.0</span> <span class="o">/</span> <span class="n">w</span><span class="p">))</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">conj</span><span class="p">()))</span>
                <span class="n">S_L_inv_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">S_L_inv</span><span class="p">)</span>
                <span class="n">S_L_list</span><span class="p">[</span><span class="n">imps</span><span class="p">]</span> <span class="o">=</span> <span class="n">S_L_list</span><span class="p">[</span><span class="n">imps</span><span class="p">]</span><span class="o">.</span><span class="n">array</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">S_L_list</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">,]</span> <span class="o">*</span> <span class="p">(</span><span class="n">mps</span><span class="o">.</span><span class="n">site_num</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">S_L_inv_list</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">,]</span> <span class="o">*</span> <span class="p">(</span><span class="n">mps</span><span class="o">.</span><span class="n">site_num</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">imps</span> <span class="ow">in</span> <span class="n">mps</span><span class="o">.</span><span class="n">iter_idx_list</span><span class="p">(</span><span class="n">full</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
            <span class="n">shape</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">mps</span><span class="p">[</span><span class="n">imps</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
            <span class="n">ltensor</span> <span class="o">=</span> <span class="n">environ</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="s2">&quot;L&quot;</span><span class="p">,</span> <span class="n">imps</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">imps</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">site_num</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>
                <span class="c1"># the coefficient site</span>
                <span class="n">rtensor</span> <span class="o">=</span> <span class="n">ones</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
                <span class="n">hop</span> <span class="o">=</span> <span class="n">hop_factory</span><span class="p">(</span><span class="n">ltensor</span><span class="p">,</span> <span class="n">rtensor</span><span class="p">,</span> <span class="n">mpo</span><span class="p">[</span><span class="n">imps</span><span class="p">],</span> <span class="nb">len</span><span class="p">(</span><span class="n">shape</span><span class="p">))</span>

                <span class="n">S_inv</span> <span class="o">=</span> <span class="n">xp</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">xp</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">dtype</span><span class="o">=</span><span class="n">mps</span><span class="o">.</span><span class="n">dtype</span><span class="p">))</span>
                <span class="k">def</span> <span class="nf">func1</span><span class="p">(</span><span class="n">y</span><span class="p">):</span>
                    <span class="n">func</span> <span class="o">=</span> <span class="n">integrand_func_factory</span><span class="p">(</span><span class="n">shape</span><span class="p">,</span> <span class="n">hop</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="n">S_inv</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span>
                            <span class="n">coef</span><span class="p">,</span> <span class="n">Ovlp_inv1</span><span class="o">=</span><span class="n">S_L_inv_list</span><span class="p">[</span><span class="n">imps</span><span class="o">+</span><span class="mi">1</span><span class="p">],</span>
                            <span class="n">Ovlp_inv0</span><span class="o">=</span><span class="n">S_L_inv_list</span><span class="p">[</span><span class="n">imps</span><span class="p">],</span> <span class="n">Ovlp0</span><span class="o">=</span><span class="n">S_L_list</span><span class="p">[</span><span class="n">imps</span><span class="p">])</span>
                    <span class="k">return</span> <span class="n">func</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>

                <span class="n">ms</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">expm_krylov</span><span class="p">(</span><span class="n">func1</span><span class="p">,</span> <span class="n">evolve_dt</span><span class="p">,</span> <span class="n">mps</span><span class="p">[</span><span class="n">imps</span><span class="p">]</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span><span class="o">.</span><span class="n">array</span><span class="p">)</span>
                <span class="n">mps</span><span class="p">[</span><span class="n">imps</span><span class="p">]</span> <span class="o">=</span> <span class="n">ms</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">shape</span><span class="p">)</span>
                <span class="k">continue</span>

            <span class="c1"># perform qr on the environment mps</span>
            <span class="n">qnbigl</span><span class="p">,</span> <span class="n">qnbigr</span> <span class="o">=</span> <span class="n">environ_mps</span><span class="o">.</span><span class="n">_get_big_qn</span><span class="p">(</span><span class="n">imps</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">u</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">qnlset</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">qnrset</span> <span class="o">=</span> <span class="n">svd_qn</span><span class="o">.</span><span class="n">Csvd</span><span class="p">(</span>
                <span class="n">environ_mps</span><span class="p">[</span><span class="n">imps</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">asnumpy</span><span class="p">(),</span>
                <span class="n">qnbigl</span><span class="p">,</span>
                <span class="n">qnbigr</span><span class="p">,</span>
                <span class="n">environ_mps</span><span class="o">.</span><span class="n">qntot</span><span class="p">,</span>
                <span class="n">system</span><span class="o">=</span><span class="s2">&quot;R&quot;</span><span class="p">,</span>
                <span class="n">full_matrices</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">vt</span> <span class="o">=</span> <span class="n">v</span><span class="o">.</span><span class="n">T</span>

            <span class="n">environ_mps</span><span class="p">[</span><span class="n">imps</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">vt</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">environ_mps</span><span class="p">[</span><span class="n">imps</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>

            <span class="n">rtensor</span> <span class="o">=</span> <span class="n">environ</span><span class="o">.</span><span class="n">GetLR</span><span class="p">(</span>
                <span class="s2">&quot;R&quot;</span><span class="p">,</span> <span class="n">imps</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">environ_mps</span><span class="p">,</span> <span class="n">mpo</span><span class="p">,</span> <span class="n">itensor</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s2">&quot;System&quot;</span>
            <span class="p">)</span>

            <span class="n">regular_s</span> <span class="o">=</span> <span class="n">_mu_regularize</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">epsilon</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">evolve_config</span><span class="o">.</span><span class="n">reg_epsilon</span><span class="p">)</span>

            <span class="n">us</span> <span class="o">=</span> <span class="n">Matrix</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">s</span><span class="p">)))</span>

            <span class="n">rtensor</span> <span class="o">=</span> <span class="n">tensordot</span><span class="p">(</span><span class="n">rtensor</span><span class="p">,</span> <span class="n">us</span><span class="p">,</span> <span class="n">axes</span><span class="o">=</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">))</span>

            <span class="n">environ_mps</span><span class="p">[</span><span class="n">imps</span><span class="p">]</span> <span class="o">=</span> <span class="n">tensordot</span><span class="p">(</span><span class="n">environ_mps</span><span class="p">[</span><span class="n">imps</span><span class="p">],</span> <span class="n">us</span><span class="p">,</span> <span class="n">axes</span><span class="o">=</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
            <span class="n">environ_mps</span><span class="o">.</span><span class="n">qn</span><span class="p">[</span><span class="n">imps</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">qnrset</span>

            <span class="n">S_inv</span> <span class="o">=</span> <span class="n">Matrix</span><span class="p">(</span><span class="n">u</span><span class="p">)</span><span class="o">.</span><span class="n">conj</span><span class="p">()</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">xp</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="mf">1.0</span> <span class="o">/</span> <span class="n">regular_s</span><span class="p">))</span><span class="o">.</span><span class="n">T</span>

            <span class="n">hop</span> <span class="o">=</span> <span class="n">hop_factory</span><span class="p">(</span><span class="n">ltensor</span><span class="p">,</span> <span class="n">rtensor</span><span class="p">,</span> <span class="n">mpo</span><span class="p">[</span><span class="n">imps</span><span class="p">],</span> <span class="nb">len</span><span class="p">(</span><span class="n">shape</span><span class="p">))</span>
            <span class="n">func</span> <span class="o">=</span> <span class="n">integrand_func_factory</span><span class="p">(</span><span class="n">shape</span><span class="p">,</span> <span class="n">hop</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="n">S_inv</span><span class="o">.</span><span class="n">array</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span>
                    <span class="n">coef</span><span class="p">,</span> <span class="n">Ovlp_inv1</span><span class="o">=</span><span class="n">S_L_inv_list</span><span class="p">[</span><span class="n">imps</span><span class="o">+</span><span class="mi">1</span><span class="p">],</span>
                    <span class="n">Ovlp_inv0</span><span class="o">=</span><span class="n">S_L_inv_list</span><span class="p">[</span><span class="n">imps</span><span class="p">],</span> <span class="n">Ovlp0</span><span class="o">=</span><span class="n">S_L_list</span><span class="p">[</span><span class="n">imps</span><span class="p">])</span>

            <span class="n">sol</span> <span class="o">=</span> <span class="n">solve_ivp</span><span class="p">(</span>
                <span class="n">func</span><span class="p">,</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">evolve_dt</span><span class="p">),</span> <span class="n">mps</span><span class="p">[</span><span class="n">imps</span><span class="p">]</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span><span class="o">.</span><span class="n">array</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s2">&quot;RK45&quot;</span>
            <span class="p">)</span>
            <span class="n">cmf_rk_steps</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">sol</span><span class="o">.</span><span class="n">t</span><span class="p">))</span>
            <span class="n">ms</span> <span class="o">=</span> <span class="n">sol</span><span class="o">.</span><span class="n">y</span><span class="p">[:,</span> <span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">shape</span><span class="p">)</span>
            <span class="n">mps</span><span class="p">[</span><span class="n">imps</span><span class="p">]</span> <span class="o">=</span> <span class="n">ms</span>
        <span class="n">steps_stat</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">describe</span><span class="p">(</span><span class="n">cmf_rk_steps</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;</span><span class="si">{self.evolve_config.method}</span><span class="s2"> CMF steps: </span><span class="si">{steps_stat}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="c1"># new_mps.evolve_config.stat = steps_stat</span>

        <span class="k">return</span> <span class="n">mps</span>

    <span class="nd">@adaptive_tdvp</span>
    <span class="k">def</span> <span class="nf">_evolve_dmrg_tdvp_ps</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mpo</span><span class="p">,</span> <span class="n">evolve_dt</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;Mps&quot;</span><span class="p">:</span>
        <span class="c1"># PhysRevB.94.165116</span>
        <span class="c1"># TDVP projector splitting</span>
        <span class="n">imag_time</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">iscomplex</span><span class="p">(</span><span class="n">evolve_dt</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">imag_time</span><span class="p">:</span>
            <span class="n">mps</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="n">mps_conj</span> <span class="o">=</span> <span class="n">mps</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">mps</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">to_complex</span><span class="p">()</span>
            <span class="n">mps_conj</span> <span class="o">=</span> <span class="n">mps</span><span class="o">.</span><span class="n">conj</span><span class="p">()</span>  <span class="c1"># another copy, so 3x memory is used.</span>

        <span class="c1"># construct the environment matrix</span>
        <span class="c1"># almost half is not used. Not a big deal.</span>
        <span class="n">environ</span> <span class="o">=</span> <span class="n">Environ</span><span class="p">(</span><span class="n">mps</span><span class="p">,</span> <span class="n">mpo</span><span class="p">)</span>

        <span class="c1"># a workaround for https://github.com/scipy/scipy/issues/10164</span>
        <span class="k">if</span> <span class="n">imag_time</span><span class="p">:</span>
            <span class="n">evolve_dt</span> <span class="o">=</span> <span class="o">-</span><span class="n">evolve_dt</span><span class="o">.</span><span class="n">imag</span>
            <span class="c1"># used in calculating derivatives</span>
            <span class="n">coef</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">coef</span> <span class="o">=</span> <span class="mi">1</span><span class="n">j</span>

        <span class="c1"># todo: remove USE_RK if proved to be useless</span>
        <span class="n">USE_RK</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="c1"># statistics for debug output</span>
        <span class="n">local_steps</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="c1"># sweep for 2 rounds</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">imps</span> <span class="ow">in</span> <span class="n">mps</span><span class="o">.</span><span class="n">iter_idx_list</span><span class="p">(</span><span class="n">full</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
                <span class="n">system</span> <span class="o">=</span> <span class="s2">&quot;L&quot;</span> <span class="k">if</span> <span class="n">mps</span><span class="o">.</span><span class="n">to_right</span> <span class="k">else</span> <span class="s2">&quot;R&quot;</span>
                <span class="n">ltensor</span> <span class="o">=</span> <span class="n">environ</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="s2">&quot;L&quot;</span><span class="p">,</span> <span class="n">imps</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
                <span class="n">rtensor</span> <span class="o">=</span> <span class="n">environ</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="s2">&quot;R&quot;</span><span class="p">,</span> <span class="n">imps</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>

                <span class="n">shape</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">mps</span><span class="p">[</span><span class="n">imps</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
                <span class="n">l_array</span> <span class="o">=</span> <span class="n">ltensor</span><span class="o">.</span><span class="n">array</span>
                <span class="n">r_array</span> <span class="o">=</span> <span class="n">rtensor</span><span class="o">.</span><span class="n">array</span>

                <span class="n">hop</span> <span class="o">=</span> <span class="n">hop_factory</span><span class="p">(</span><span class="n">l_array</span><span class="p">,</span> <span class="n">r_array</span><span class="p">,</span> <span class="n">mpo</span><span class="p">[</span><span class="n">imps</span><span class="p">]</span><span class="o">.</span><span class="n">array</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">shape</span><span class="p">))</span>

                <span class="k">def</span> <span class="nf">hop_svt</span><span class="p">(</span><span class="n">ms</span><span class="p">):</span>
                    <span class="c1"># S-a   l-S</span>
                    <span class="c1">#</span>
                    <span class="c1"># O-b - b-O</span>
                    <span class="c1">#</span>
                    <span class="c1"># S-c   k-S</span>

                    <span class="n">path</span> <span class="o">=</span> <span class="p">[([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="s2">&quot;abc, ck -&gt; abk&quot;</span><span class="p">),</span> <span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="s2">&quot;abk, lbk -&gt; al&quot;</span><span class="p">)]</span>
                    <span class="n">HC</span> <span class="o">=</span> <span class="n">multi_tensor_contract</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">l_array</span><span class="p">,</span> <span class="n">ms</span><span class="p">,</span> <span class="n">r_array</span><span class="p">)</span>
                    <span class="k">return</span> <span class="n">HC</span>

                <span class="k">if</span> <span class="n">USE_RK</span><span class="p">:</span>
                    <span class="k">def</span> <span class="nf">func</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
                        <span class="k">return</span> <span class="n">hop</span><span class="p">(</span><span class="n">y</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">shape</span><span class="p">))</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span> <span class="o">/</span> <span class="n">coef</span>
                    <span class="n">sol</span> <span class="o">=</span> <span class="n">solve_ivp</span><span class="p">(</span>
                        <span class="n">func</span><span class="p">,</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">evolve_dt</span> <span class="o">/</span> <span class="mf">2.0</span><span class="p">),</span> <span class="n">mps</span><span class="p">[</span><span class="n">imps</span><span class="p">]</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span><span class="o">.</span><span class="n">array</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s2">&quot;RK45&quot;</span>
                    <span class="p">)</span>
                    <span class="n">local_steps</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">sol</span><span class="o">.</span><span class="n">t</span><span class="p">))</span>
                    <span class="n">mps_t</span> <span class="o">=</span> <span class="n">sol</span><span class="o">.</span><span class="n">y</span><span class="p">[:,</span> <span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># Can&#39;t use the same func because here H should be Hermitian</span>
                    <span class="k">def</span> <span class="nf">func</span><span class="p">(</span><span class="n">y</span><span class="p">):</span>
                        <span class="k">return</span> <span class="n">hop</span><span class="p">(</span><span class="n">y</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">shape</span><span class="p">))</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>
                    <span class="n">mps_t</span><span class="p">,</span> <span class="n">j</span> <span class="o">=</span> <span class="n">expm_krylov</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="p">(</span><span class="n">evolve_dt</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="n">coef</span><span class="p">,</span> <span class="n">mps</span><span class="p">[</span><span class="n">imps</span><span class="p">]</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span><span class="o">.</span><span class="n">array</span><span class="p">)</span>
                    <span class="n">local_steps</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">j</span><span class="p">)</span>
                <span class="n">mps_t</span> <span class="o">=</span> <span class="n">mps_t</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">shape</span><span class="p">)</span>

                <span class="n">qnbigl</span><span class="p">,</span> <span class="n">qnbigr</span> <span class="o">=</span> <span class="n">mps</span><span class="o">.</span><span class="n">_get_big_qn</span><span class="p">(</span><span class="n">imps</span><span class="p">)</span>
                <span class="n">u</span><span class="p">,</span> <span class="n">qnlset</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">qnrset</span> <span class="o">=</span> <span class="n">svd_qn</span><span class="o">.</span><span class="n">Csvd</span><span class="p">(</span>
                    <span class="n">asnumpy</span><span class="p">(</span><span class="n">mps_t</span><span class="p">),</span>
                    <span class="n">qnbigl</span><span class="p">,</span>
                    <span class="n">qnbigr</span><span class="p">,</span>
                    <span class="n">mps</span><span class="o">.</span><span class="n">qntot</span><span class="p">,</span>
                    <span class="n">QR</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                    <span class="n">system</span><span class="o">=</span><span class="n">system</span><span class="p">,</span>
                    <span class="n">full_matrices</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="n">vt</span> <span class="o">=</span> <span class="n">v</span><span class="o">.</span><span class="n">T</span>

                <span class="k">if</span> <span class="ow">not</span> <span class="n">mps</span><span class="o">.</span><span class="n">to_right</span> <span class="ow">and</span> <span class="n">imps</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">mps</span><span class="p">[</span><span class="n">imps</span><span class="p">]</span> <span class="o">=</span> <span class="n">vt</span><span class="o">.</span><span class="n">reshape</span><span class="p">([</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span>
                    <span class="n">mps_conj</span><span class="p">[</span><span class="n">imps</span><span class="p">]</span> <span class="o">=</span> <span class="n">mps</span><span class="p">[</span><span class="n">imps</span><span class="p">]</span><span class="o">.</span><span class="n">conj</span><span class="p">()</span>
                    <span class="n">mps</span><span class="o">.</span><span class="n">qn</span><span class="p">[</span><span class="n">imps</span><span class="p">]</span> <span class="o">=</span> <span class="n">qnrset</span>

                    <span class="n">rtensor</span> <span class="o">=</span> <span class="n">environ</span><span class="o">.</span><span class="n">GetLR</span><span class="p">(</span>
                        <span class="s2">&quot;R&quot;</span><span class="p">,</span> <span class="n">imps</span><span class="p">,</span> <span class="n">mps</span><span class="p">,</span> <span class="n">mpo</span><span class="p">,</span> <span class="n">itensor</span><span class="o">=</span><span class="n">rtensor</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s2">&quot;System&quot;</span>
                    <span class="p">)</span>
                    <span class="n">r_array</span> <span class="o">=</span> <span class="n">rtensor</span><span class="o">.</span><span class="n">array</span>

                    <span class="c1"># reverse update u site</span>
                    <span class="n">shape_u</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">shape</span>

                    <span class="k">if</span> <span class="n">USE_RK</span><span class="p">:</span>
                        <span class="k">def</span> <span class="nf">func_u</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
                            <span class="k">return</span> <span class="n">hop_svt</span><span class="p">(</span><span class="n">y</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">shape_u</span><span class="p">))</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span> <span class="o">/</span> <span class="n">coef</span>
                        <span class="n">sol_u</span> <span class="o">=</span> <span class="n">solve_ivp</span><span class="p">(</span>
                            <span class="n">func_u</span><span class="p">,</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="n">evolve_dt</span> <span class="o">/</span> <span class="mi">2</span><span class="p">),</span> <span class="n">u</span><span class="o">.</span><span class="n">ravel</span><span class="p">(),</span> <span class="n">method</span><span class="o">=</span><span class="s2">&quot;RK45&quot;</span>
                        <span class="p">)</span>
                        <span class="n">local_steps</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">sol_u</span><span class="o">.</span><span class="n">t</span><span class="p">))</span>
                        <span class="n">mps_t</span> <span class="o">=</span> <span class="n">sol_u</span><span class="o">.</span><span class="n">y</span><span class="p">[:,</span> <span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">def</span> <span class="nf">func_u</span><span class="p">(</span><span class="n">y</span><span class="p">):</span>
                            <span class="k">return</span> <span class="n">hop_svt</span><span class="p">(</span><span class="n">y</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">shape_u</span><span class="p">))</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>
                        <span class="n">mps_t</span><span class="p">,</span> <span class="n">j</span> <span class="o">=</span> <span class="n">expm_krylov</span><span class="p">(</span><span class="n">func_u</span><span class="p">,</span> <span class="p">(</span><span class="o">-</span><span class="n">evolve_dt</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="n">coef</span><span class="p">,</span> <span class="n">u</span><span class="o">.</span><span class="n">ravel</span><span class="p">())</span>
                        <span class="n">local_steps</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">j</span><span class="p">)</span>
                    <span class="n">mps_t</span> <span class="o">=</span> <span class="n">mps_t</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">shape_u</span><span class="p">)</span>

                    <span class="n">mps</span><span class="p">[</span><span class="n">imps</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">tensordot</span><span class="p">(</span>
                        <span class="n">mps</span><span class="p">[</span><span class="n">imps</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">array</span><span class="p">,</span>
                        <span class="n">mps_t</span><span class="p">,</span>
                        <span class="n">axes</span><span class="o">=</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
                    <span class="p">)</span>
                    <span class="n">mps_conj</span><span class="p">[</span><span class="n">imps</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">mps</span><span class="p">[</span><span class="n">imps</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">conj</span><span class="p">()</span>

                <span class="k">elif</span> <span class="n">mps</span><span class="o">.</span><span class="n">to_right</span> <span class="ow">and</span> <span class="n">imps</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">mps</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">mps</span><span class="p">[</span><span class="n">imps</span><span class="p">]</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">shape</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
                    <span class="n">mps_conj</span><span class="p">[</span><span class="n">imps</span><span class="p">]</span> <span class="o">=</span> <span class="n">mps</span><span class="p">[</span><span class="n">imps</span><span class="p">]</span><span class="o">.</span><span class="n">conj</span><span class="p">()</span>
                    <span class="n">mps</span><span class="o">.</span><span class="n">qn</span><span class="p">[</span><span class="n">imps</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">qnlset</span>

                    <span class="n">ltensor</span> <span class="o">=</span> <span class="n">environ</span><span class="o">.</span><span class="n">GetLR</span><span class="p">(</span>
                        <span class="s2">&quot;L&quot;</span><span class="p">,</span> <span class="n">imps</span><span class="p">,</span> <span class="n">mps</span><span class="p">,</span> <span class="n">mpo</span><span class="p">,</span> <span class="n">itensor</span><span class="o">=</span><span class="n">ltensor</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s2">&quot;System&quot;</span>
                    <span class="p">)</span>
                    <span class="n">l_array</span> <span class="o">=</span> <span class="n">ltensor</span><span class="o">.</span><span class="n">array</span>

                    <span class="c1"># reverse update svt site</span>
                    <span class="n">shape_svt</span> <span class="o">=</span> <span class="n">vt</span><span class="o">.</span><span class="n">shape</span>

                    <span class="k">if</span> <span class="n">USE_RK</span><span class="p">:</span>
                        <span class="k">def</span> <span class="nf">func_svt</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
                            <span class="k">return</span> <span class="n">hop_svt</span><span class="p">(</span><span class="n">y</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">shape_svt</span><span class="p">))</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span> <span class="o">/</span> <span class="n">coef</span>
                        <span class="n">sol_svt</span> <span class="o">=</span> <span class="n">solve_ivp</span><span class="p">(</span>
                            <span class="n">func_svt</span><span class="p">,</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="n">evolve_dt</span> <span class="o">/</span> <span class="mi">2</span><span class="p">),</span> <span class="n">vt</span><span class="o">.</span><span class="n">ravel</span><span class="p">(),</span> <span class="n">method</span><span class="o">=</span><span class="s2">&quot;RK45&quot;</span>
                        <span class="p">)</span>
                        <span class="n">local_steps</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">sol_svt</span><span class="o">.</span><span class="n">t</span><span class="p">))</span>
                        <span class="n">mps_t</span> <span class="o">=</span> <span class="n">sol_svt</span><span class="o">.</span><span class="n">y</span><span class="p">[:,</span> <span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">def</span> <span class="nf">func_svt</span><span class="p">(</span><span class="n">y</span><span class="p">):</span>
                            <span class="k">return</span> <span class="n">hop_svt</span><span class="p">(</span><span class="n">y</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">shape_svt</span><span class="p">))</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>
                        <span class="n">mps_t</span><span class="p">,</span> <span class="n">j</span> <span class="o">=</span> <span class="n">expm_krylov</span><span class="p">(</span><span class="n">func_svt</span><span class="p">,</span> <span class="p">(</span><span class="o">-</span><span class="n">evolve_dt</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="n">coef</span><span class="p">,</span> <span class="n">vt</span><span class="o">.</span><span class="n">ravel</span><span class="p">())</span>
                        <span class="n">local_steps</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">j</span><span class="p">)</span>
                    <span class="n">mps_t</span> <span class="o">=</span> <span class="n">mps_t</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">shape_svt</span><span class="p">)</span>

                    <span class="n">mps</span><span class="p">[</span><span class="n">imps</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">tensordot</span><span class="p">(</span>
                        <span class="n">mps_t</span><span class="p">,</span>
                        <span class="n">mps</span><span class="p">[</span><span class="n">imps</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">array</span><span class="p">,</span>
                        <span class="n">axes</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
                    <span class="p">)</span>
                    <span class="n">mps_conj</span><span class="p">[</span><span class="n">imps</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">mps</span><span class="p">[</span><span class="n">imps</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">conj</span><span class="p">()</span>

                <span class="k">else</span><span class="p">:</span>
                    <span class="n">mps</span><span class="p">[</span><span class="n">imps</span><span class="p">]</span> <span class="o">=</span> <span class="n">mps_t</span>
                    <span class="n">mps_conj</span><span class="p">[</span><span class="n">imps</span><span class="p">]</span> <span class="o">=</span> <span class="n">mps</span><span class="p">[</span><span class="n">imps</span><span class="p">]</span><span class="o">.</span><span class="n">conj</span><span class="p">()</span>
            <span class="n">mps</span><span class="o">.</span><span class="n">_switch_direction</span><span class="p">()</span>

        <span class="n">steps_stat</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">describe</span><span class="p">(</span><span class="n">local_steps</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;TDVP-PS CMF steps: </span><span class="si">{steps_stat}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">mps</span><span class="o">.</span><span class="n">evolve_config</span><span class="o">.</span><span class="n">stat</span> <span class="o">=</span> <span class="n">steps_stat</span>

        <span class="k">return</span> <span class="n">mps</span>

    <span class="k">def</span> <span class="nf">evolve_exact</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">h_mpo</span><span class="p">,</span> <span class="n">evolve_dt</span><span class="p">,</span> <span class="n">space</span><span class="p">):</span>
        <span class="n">MPOprop</span><span class="p">,</span> <span class="n">HAM</span><span class="p">,</span> <span class="n">Etot</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">hybrid_exact_propagator</span><span class="p">(</span>
            <span class="n">h_mpo</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.0</span><span class="n">j</span> <span class="o">*</span> <span class="n">evolve_dt</span><span class="p">,</span> <span class="n">space</span>
        <span class="p">)</span>
        <span class="n">new_mps</span> <span class="o">=</span> <span class="n">MPOprop</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">canonicalise</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">unitary_propagation</span><span class="p">(</span><span class="n">new_mps</span><span class="o">.</span><span class="n">tdh_wfns</span><span class="p">,</span> <span class="n">HAM</span><span class="p">,</span> <span class="n">Etot</span><span class="p">,</span> <span class="n">evolve_dt</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">new_mps</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">digest</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="mi">10</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">site_num</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="n">prod</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">ms</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">:</span>
            <span class="n">prod</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">tensordot</span><span class="p">(</span><span class="n">prod</span><span class="p">,</span> <span class="n">ms</span><span class="p">,</span> <span class="n">axes</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">prod</span> <span class="o">=</span> <span class="n">prod</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">prod</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">prod</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]))</span>
        <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;var&quot;</span><span class="p">:</span> <span class="n">prod</span><span class="o">.</span><span class="n">var</span><span class="p">(),</span> <span class="s2">&quot;mean&quot;</span><span class="p">:</span> <span class="n">prod</span><span class="o">.</span><span class="n">mean</span><span class="p">(),</span> <span class="s2">&quot;ptp&quot;</span><span class="p">:</span> <span class="n">prod</span><span class="o">.</span><span class="n">ptp</span><span class="p">()}</span>

    <span class="c1"># put the below 2 constructors here because they really depend on the implement details of MPS (at least the</span>
    <span class="c1"># Hartree part).</span>
<div class="viewcode-block" id="Mps.construct_hybrid_Ham"><a class="viewcode-back" href="../../../mps.html#renormalizer.mps.Mps.construct_hybrid_Ham">[docs]</a>    <span class="k">def</span> <span class="nf">construct_hybrid_Ham</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mpo_indep</span><span class="p">,</span> <span class="n">debug</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        construct hybrid DMRG and Hartree(-Fock) Hamiltonian</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">mol_list</span> <span class="o">=</span> <span class="n">mpo_indep</span><span class="o">.</span><span class="n">mol_list</span>
        <span class="n">WFN</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tdh_wfns</span>
        <span class="n">nmols</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">mol_list</span><span class="p">)</span>

        <span class="c1"># many-body electronic part</span>
        <span class="n">A_el</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">e_occupations</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;dmrg_occ: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">A_el</span><span class="p">)</span>

        <span class="c1"># many-body vibration part</span>
        <span class="n">B_vib</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">iwfn</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">imol</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nmols</span><span class="p">):</span>
            <span class="n">B_vib</span><span class="o">.</span><span class="n">append</span><span class="p">([])</span>
            <span class="k">for</span> <span class="n">ph</span> <span class="ow">in</span> <span class="n">mol_list</span><span class="p">[</span><span class="n">imol</span><span class="p">]</span><span class="o">.</span><span class="n">hartree_phs</span><span class="p">:</span>
                <span class="n">B_vib</span><span class="p">[</span><span class="n">imol</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">mflib</span><span class="o">.</span><span class="n">exp_value</span><span class="p">(</span><span class="n">WFN</span><span class="p">[</span><span class="n">iwfn</span><span class="p">],</span> <span class="n">ph</span><span class="o">.</span><span class="n">h_dep</span><span class="p">,</span> <span class="n">WFN</span><span class="p">[</span><span class="n">iwfn</span><span class="p">]))</span>
                <span class="n">iwfn</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">B_vib_mol</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">i</span><span class="p">))</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">B_vib</span><span class="p">]</span>

        <span class="n">Etot</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="c1"># construct new HMPO</span>
        <span class="n">e_mean</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">expectation</span><span class="p">(</span><span class="n">mpo_indep</span><span class="p">)</span>
        <span class="n">elocal_offset</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
            <span class="p">[</span><span class="n">mol_list</span><span class="p">[</span><span class="n">imol</span><span class="p">]</span><span class="o">.</span><span class="n">hartree_e0</span> <span class="o">+</span> <span class="n">B_vib_mol</span><span class="p">[</span><span class="n">imol</span><span class="p">]</span> <span class="k">for</span> <span class="n">imol</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nmols</span><span class="p">)]</span>
        <span class="p">)</span><span class="o">.</span><span class="n">real</span>
        <span class="n">e_mean</span> <span class="o">+=</span> <span class="n">A_el</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">elocal_offset</span><span class="p">)</span>
        <span class="n">total_offset</span> <span class="o">=</span> <span class="n">mpo_indep</span><span class="o">.</span><span class="n">offset</span> <span class="o">+</span> <span class="n">Quantity</span><span class="p">(</span><span class="n">e_mean</span><span class="o">.</span><span class="n">real</span><span class="p">)</span>
        <span class="n">MPO</span> <span class="o">=</span> <span class="n">Mpo</span><span class="p">(</span>
            <span class="n">mol_list</span><span class="p">,</span>
            <span class="n">mpo_indep</span><span class="o">.</span><span class="n">rep</span><span class="p">,</span>
            <span class="n">elocal_offset</span><span class="o">=</span><span class="n">elocal_offset</span><span class="p">,</span>
            <span class="n">offset</span><span class="o">=</span><span class="n">total_offset</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="n">Etot</span> <span class="o">+=</span> <span class="n">e_mean</span>

        <span class="n">iwfn</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">HAM</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">imol</span><span class="p">,</span> <span class="n">mol</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">mol_list</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">iph</span><span class="p">,</span> <span class="n">ph</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">mol</span><span class="o">.</span><span class="n">hartree_phs</span><span class="p">):</span>
                <span class="n">e_mean</span> <span class="o">=</span> <span class="n">mflib</span><span class="o">.</span><span class="n">exp_value</span><span class="p">(</span><span class="n">WFN</span><span class="p">[</span><span class="n">iwfn</span><span class="p">],</span> <span class="n">ph</span><span class="o">.</span><span class="n">h_indep</span><span class="p">,</span> <span class="n">WFN</span><span class="p">[</span><span class="n">iwfn</span><span class="p">])</span>
                <span class="n">Etot</span> <span class="o">+=</span> <span class="n">e_mean</span><span class="o">.</span><span class="n">real</span>
                <span class="n">e_mean</span> <span class="o">+=</span> <span class="n">A_el</span><span class="p">[</span><span class="n">imol</span><span class="p">]</span> <span class="o">*</span> <span class="n">B_vib</span><span class="p">[</span><span class="n">imol</span><span class="p">][</span><span class="n">iph</span><span class="p">]</span>
                <span class="n">HAM</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="n">ph</span><span class="o">.</span><span class="n">h_indep</span>
                    <span class="o">+</span> <span class="n">ph</span><span class="o">.</span><span class="n">h_dep</span> <span class="o">*</span> <span class="n">A_el</span><span class="p">[</span><span class="n">imol</span><span class="p">]</span>
                    <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">([</span><span class="n">e_mean</span><span class="p">]</span> <span class="o">*</span> <span class="n">WFN</span><span class="p">[</span><span class="n">iwfn</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                <span class="p">)</span>
                <span class="n">iwfn</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Etot= </span><span class="si">%g</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">Etot</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">debug</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">MPO</span><span class="p">,</span> <span class="n">HAM</span><span class="p">,</span> <span class="n">Etot</span><span class="p">,</span> <span class="n">A_el</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">MPO</span><span class="p">,</span> <span class="n">HAM</span><span class="p">,</span> <span class="n">Etot</span></div>

    <span class="c1"># provide e_mean and mpo_indep separately because e_mean can be precomputed and stored to avoid multiple computation</span>
<div class="viewcode-block" id="Mps.hybrid_exact_propagator"><a class="viewcode-back" href="../../../mps.html#renormalizer.mps.Mps.hybrid_exact_propagator">[docs]</a>    <span class="k">def</span> <span class="nf">hybrid_exact_propagator</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mpo_indep</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">space</span><span class="o">=</span><span class="s2">&quot;GS&quot;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        construct the exact propagator in the GS space or single molecule</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">assert</span> <span class="n">space</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;GS&quot;</span><span class="p">,</span> <span class="s2">&quot;EX&quot;</span><span class="p">]</span>

        <span class="n">e_mean</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">expectation</span><span class="p">(</span><span class="n">mpo_indep</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;e_mean in exact propagator: </span><span class="si">%g</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">e_mean</span><span class="p">)</span>

        <span class="n">total_offset</span> <span class="o">=</span> <span class="p">(</span><span class="n">mpo_indep</span><span class="o">.</span><span class="n">offset</span> <span class="o">+</span> <span class="n">Quantity</span><span class="p">(</span><span class="n">e_mean</span><span class="o">.</span><span class="n">real</span><span class="p">))</span><span class="o">.</span><span class="n">as_au</span><span class="p">()</span>
        <span class="n">MPOprop</span> <span class="o">=</span> <span class="n">Mpo</span><span class="o">.</span><span class="n">exact_propagator</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mol_list</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">space</span><span class="o">=</span><span class="n">space</span><span class="p">,</span> <span class="n">shift</span><span class="o">=-</span><span class="n">total_offset</span>
        <span class="p">)</span>

        <span class="n">Etot</span> <span class="o">=</span> <span class="n">total_offset</span>

        <span class="c1"># TDH propagator</span>
        <span class="n">iwfn</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">HAM</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">mol</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">mol_list</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">ph</span> <span class="ow">in</span> <span class="n">mol</span><span class="o">.</span><span class="n">hartree_phs</span><span class="p">:</span>
                <span class="n">h_vib_indep</span> <span class="o">=</span> <span class="n">ph</span><span class="o">.</span><span class="n">h_indep</span>
                <span class="n">h_vib_dep</span> <span class="o">=</span> <span class="n">ph</span><span class="o">.</span><span class="n">h_dep</span>
                <span class="n">e_mean</span> <span class="o">=</span> <span class="n">mflib</span><span class="o">.</span><span class="n">exp_value</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tdh_wfns</span><span class="p">[</span><span class="n">iwfn</span><span class="p">],</span> <span class="n">h_vib_indep</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">tdh_wfns</span><span class="p">[</span><span class="n">iwfn</span><span class="p">])</span>
                <span class="k">if</span> <span class="n">space</span> <span class="o">==</span> <span class="s2">&quot;EX&quot;</span><span class="p">:</span>
                    <span class="n">e_mean</span> <span class="o">+=</span> <span class="n">mflib</span><span class="o">.</span><span class="n">exp_value</span><span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">tdh_wfns</span><span class="p">[</span><span class="n">iwfn</span><span class="p">],</span> <span class="n">h_vib_dep</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">tdh_wfns</span><span class="p">[</span><span class="n">iwfn</span><span class="p">]</span>
                    <span class="p">)</span>
                <span class="n">Etot</span> <span class="o">+=</span> <span class="n">e_mean</span>

                <span class="k">if</span> <span class="n">space</span> <span class="o">==</span> <span class="s2">&quot;GS&quot;</span><span class="p">:</span>
                    <span class="n">ham</span> <span class="o">=</span> <span class="n">h_vib_indep</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">([</span><span class="n">e_mean</span><span class="p">]</span> <span class="o">*</span> <span class="n">ph</span><span class="o">.</span><span class="n">n_phys_dim</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">space</span> <span class="o">==</span> <span class="s2">&quot;EX&quot;</span><span class="p">:</span>
                    <span class="n">ham</span> <span class="o">=</span> <span class="n">h_vib_indep</span> <span class="o">+</span> <span class="n">h_vib_dep</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">([</span><span class="n">e_mean</span><span class="p">]</span> <span class="o">*</span> <span class="n">ph</span><span class="o">.</span><span class="n">n_phys_dim</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">assert</span> <span class="kc">False</span>

                <span class="n">HAM</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ham</span><span class="p">)</span>
                <span class="n">iwfn</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="k">return</span> <span class="n">MPOprop</span><span class="p">,</span> <span class="n">HAM</span><span class="p">,</span> <span class="n">Etot</span></div>

    <span class="k">def</span> <span class="nf">hartree_wfn_diff</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">:</span> <span class="s2">&quot;Mps&quot;</span><span class="p">):</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tdh_wfns</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">other</span><span class="o">.</span><span class="n">tdh_wfns</span><span class="p">)</span>
        <span class="n">res</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">wfn1</span><span class="p">,</span> <span class="n">wfn2</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tdh_wfns</span><span class="p">,</span> <span class="n">other</span><span class="o">.</span><span class="n">tdh_wfns</span><span class="p">):</span>
            <span class="n">res</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="n">scipy</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span>
                    <span class="n">np</span><span class="o">.</span><span class="n">tensordot</span><span class="p">(</span><span class="n">wfn1</span><span class="p">,</span> <span class="n">wfn1</span><span class="p">,</span> <span class="n">axes</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">tensordot</span><span class="p">(</span><span class="n">wfn2</span><span class="p">,</span> <span class="n">wfn2</span><span class="p">,</span> <span class="n">axes</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
                <span class="p">)</span>
            <span class="p">)</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">res</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">full_wfn</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">xp</span><span class="o">.</span><span class="n">array</span><span class="p">:</span>
        <span class="n">dim</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">prod</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pbond_list</span><span class="p">)</span>
        <span class="k">if</span> <span class="mi">20000</span> <span class="o">&lt;</span> <span class="n">dim</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;wavefunction too large&quot;</span><span class="p">)</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">ones</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">mt</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">:</span>
            <span class="n">dim1</span> <span class="o">=</span> <span class="n">res</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">mt</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">dim2</span> <span class="o">=</span> <span class="n">mt</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">res</span> <span class="o">=</span> <span class="n">tensordot</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="n">mt</span><span class="p">,</span> <span class="n">axes</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dim1</span><span class="p">,</span> <span class="n">dim2</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">res</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">asnumpy</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_calc_reduced_density_matrix</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mp1</span><span class="p">,</span> <span class="n">mp2</span><span class="p">):</span>
        <span class="c1"># further optimization is difficult. There are totally N^2 intermediate results to remember.</span>
        <span class="n">reduced_density_matrix</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span>
            <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mol_list</span><span class="o">.</span><span class="n">mol_num</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mol_list</span><span class="o">.</span><span class="n">mol_num</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">backend</span><span class="o">.</span><span class="n">complex_dtype</span>
        <span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mol_list</span><span class="o">.</span><span class="n">mol_num</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mol_list</span><span class="o">.</span><span class="n">mol_num</span><span class="p">):</span>
                <span class="n">elem</span> <span class="o">=</span> <span class="n">ones</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
                <span class="n">e_idx</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
                <span class="k">for</span> <span class="n">mt_idx</span><span class="p">,</span> <span class="p">(</span><span class="n">mt1</span><span class="p">,</span> <span class="n">mt2</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">mp1</span><span class="p">,</span> <span class="n">mp2</span><span class="p">)):</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ephtable</span><span class="o">.</span><span class="n">is_electron</span><span class="p">(</span><span class="n">mt_idx</span><span class="p">):</span>
                        <span class="n">e_idx</span> <span class="o">+=</span> <span class="mi">1</span>
                        <span class="n">axis_idx1</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">e_idx</span> <span class="o">==</span> <span class="n">i</span><span class="p">)</span>
                        <span class="n">axis_idx2</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">e_idx</span> <span class="o">==</span> <span class="n">j</span><span class="p">)</span>
                        <span class="n">sub_mt1</span> <span class="o">=</span> <span class="n">mt1</span><span class="p">[:,</span> <span class="n">axis_idx1</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span>
                        <span class="n">sub_mt2</span> <span class="o">=</span> <span class="n">mt2</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">axis_idx2</span><span class="p">,</span> <span class="p">:]</span>
                        <span class="n">elem</span> <span class="o">=</span> <span class="n">tensordot</span><span class="p">(</span><span class="n">elem</span><span class="p">,</span> <span class="n">sub_mt1</span><span class="p">,</span> <span class="n">axes</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
                        <span class="n">elem</span> <span class="o">=</span> <span class="n">tensordot</span><span class="p">(</span><span class="n">elem</span><span class="p">,</span> <span class="n">sub_mt2</span><span class="p">,</span> <span class="n">axes</span><span class="o">=</span><span class="p">[(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)])</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">elem</span> <span class="o">=</span> <span class="n">tensordot</span><span class="p">(</span><span class="n">elem</span><span class="p">,</span> <span class="n">mt1</span><span class="p">,</span> <span class="n">axes</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
                        <span class="n">elem</span> <span class="o">=</span> <span class="n">tensordot</span><span class="p">(</span><span class="n">elem</span><span class="p">,</span> <span class="n">mt2</span><span class="p">,</span> <span class="n">axes</span><span class="o">=</span><span class="p">[(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">)])</span>
                <span class="n">reduced_density_matrix</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">elem</span><span class="o">.</span><span class="n">flatten</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">reduced_density_matrix</span>

    <span class="k">def</span> <span class="nf">calc_reduced_density_matrix</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mol_list</span><span class="o">.</span><span class="n">scheme</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">:</span>
            <span class="n">mp1</span> <span class="o">=</span> <span class="p">[</span><span class="n">mt</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">mt</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">mt</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="mi">1</span><span class="p">,</span> <span class="n">mt</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="k">for</span> <span class="n">mt</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">]</span>
            <span class="n">mp2</span> <span class="o">=</span> <span class="p">[</span><span class="n">mt</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">mt</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">1</span><span class="p">,</span> <span class="n">mt</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">mt</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span><span class="o">.</span><span class="n">conj</span><span class="p">()</span> <span class="k">for</span> <span class="n">mt</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">]</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_calc_reduced_density_matrix</span><span class="p">(</span><span class="n">mp1</span><span class="p">,</span> <span class="n">mp2</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">mol_list</span><span class="o">.</span><span class="n">scheme</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>
            <span class="c1"># be careful this method should be read-only</span>
            <span class="n">copy</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="c1"># make sure it&#39;s canonicalised before calculating reduced density matrix</span>
            <span class="n">copy</span><span class="o">.</span><span class="n">canonicalise</span><span class="p">()</span>
            <span class="n">copy</span><span class="o">.</span><span class="n">canonicalise</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mol_list</span><span class="o">.</span><span class="n">e_idx</span><span class="p">())</span>
            <span class="n">e_mo</span> <span class="o">=</span> <span class="n">copy</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">mol_list</span><span class="o">.</span><span class="n">e_idx</span><span class="p">()]</span>
            <span class="k">return</span> <span class="n">tensordot</span><span class="p">(</span><span class="n">e_mo</span><span class="o">.</span><span class="n">conj</span><span class="p">(),</span> <span class="n">e_mo</span><span class="p">,</span> <span class="n">axes</span><span class="o">=</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">)))</span><span class="o">.</span><span class="n">asnumpy</span><span class="p">()[</span><span class="mi">1</span><span class="p">:,</span> <span class="mi">1</span><span class="p">:]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">assert</span> <span class="kc">False</span>

    <span class="k">def</span> <span class="nf">dump</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fname</span><span class="p">):</span>
        <span class="n">data_dict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="c1"># version of the protocol</span>
        <span class="n">data_dict</span><span class="p">[</span><span class="s2">&quot;version&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;0.2&quot;</span>
        <span class="n">data_dict</span><span class="p">[</span><span class="s2">&quot;nsites&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">mt</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="n">data_dict</span><span class="p">[</span><span class="n">f</span><span class="s2">&quot;mt_</span><span class="si">{idx}</span><span class="s2">&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">mt</span><span class="o">.</span><span class="n">asnumpy</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">attr</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;qn&quot;</span><span class="p">,</span> <span class="s2">&quot;qnidx&quot;</span><span class="p">,</span> <span class="s2">&quot;qntot&quot;</span><span class="p">,</span> <span class="s2">&quot;to_right&quot;</span><span class="p">,</span> <span class="s2">&quot;tdh_wfns&quot;</span><span class="p">]:</span>
            <span class="n">data_dict</span><span class="p">[</span><span class="n">attr</span><span class="p">]</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attr</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">np</span><span class="o">.</span><span class="n">savez</span><span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="o">**</span><span class="n">data_dict</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;Dump mps failed, exception info: f</span><span class="si">{e}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">template_str</span> <span class="o">=</span> <span class="s2">&quot;current size: </span><span class="si">{}</span><span class="s2">, Matrix product bond dim:</span><span class="si">{}</span><span class="s2">&quot;</span>
        <span class="k">return</span> <span class="n">template_str</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="n">sizeof_fmt</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">total_bytes</span><span class="p">),</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">bond_dims</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">__setitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__setitem__</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span></div>


<span class="k">def</span> <span class="nf">projector</span><span class="p">(</span><span class="n">ms</span><span class="p">:</span> <span class="n">xp</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">left</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span> <span class="n">Ovlp_inv1</span><span class="p">:</span> <span class="n">xp</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">Ovlp0</span><span class="p">:</span> <span class="n">xp</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">=</span><span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">xp</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
    <span class="k">if</span> <span class="n">left</span><span class="p">:</span>
        <span class="n">axes</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">axes</span> <span class="o">=</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="n">Ovlp_inv1</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">proj</span> <span class="o">=</span> <span class="n">xp</span><span class="o">.</span><span class="n">tensordot</span><span class="p">(</span><span class="n">ms</span><span class="p">,</span> <span class="n">ms</span><span class="o">.</span><span class="n">conj</span><span class="p">(),</span> <span class="n">axes</span><span class="o">=</span><span class="n">axes</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># consider the case that the canonical condition is not fulfilled</span>
        <span class="k">if</span> <span class="n">left</span><span class="p">:</span>
            <span class="n">proj</span> <span class="o">=</span> <span class="n">xp</span><span class="o">.</span><span class="n">tensordot</span><span class="p">(</span><span class="n">Ovlp0</span><span class="p">,</span> <span class="n">ms</span><span class="p">,</span> <span class="n">axes</span><span class="o">=</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
            <span class="n">proj</span> <span class="o">=</span> <span class="n">xp</span><span class="o">.</span><span class="n">tensordot</span><span class="p">(</span><span class="n">proj</span><span class="p">,</span> <span class="n">Ovlp_inv1</span><span class="p">,</span> <span class="n">axes</span><span class="o">=</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
            <span class="n">proj</span> <span class="o">=</span> <span class="n">xp</span><span class="o">.</span><span class="n">tensordot</span><span class="p">(</span><span class="n">proj</span><span class="p">,</span> <span class="n">ms</span><span class="o">.</span><span class="n">conj</span><span class="p">(),</span> <span class="n">axes</span><span class="o">=</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">proj</span> <span class="o">=</span> <span class="n">xp</span><span class="o">.</span><span class="n">tensordot</span><span class="p">(</span><span class="n">ms</span><span class="p">,</span> <span class="n">Ovlp0</span><span class="p">,</span> <span class="n">axes</span><span class="o">=</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
            <span class="n">proj</span> <span class="o">=</span> <span class="n">xp</span><span class="o">.</span><span class="n">tensordot</span><span class="p">(</span><span class="n">Ovlp_inv1</span><span class="p">,</span> <span class="n">proj</span><span class="p">,</span>  <span class="n">axes</span><span class="o">=</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
            <span class="n">proj</span> <span class="o">=</span> <span class="n">xp</span><span class="o">.</span><span class="n">tensordot</span><span class="p">(</span><span class="n">proj</span><span class="p">,</span> <span class="n">ms</span><span class="o">.</span><span class="n">conj</span><span class="p">(),</span> <span class="n">axes</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>

    <span class="k">if</span> <span class="n">left</span><span class="p">:</span>
        <span class="n">sz</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">prod</span><span class="p">(</span><span class="n">ms</span><span class="o">.</span><span class="n">shape</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">sz</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">prod</span><span class="p">(</span><span class="n">ms</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">:]))</span>
    <span class="n">Iden</span> <span class="o">=</span> <span class="n">xp</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">xp</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">xp</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">sz</span><span class="p">)),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">backend</span><span class="o">.</span><span class="n">real_dtype</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">proj</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
    <span class="n">proj</span> <span class="o">=</span> <span class="n">Iden</span> <span class="o">-</span> <span class="n">proj</span>
    <span class="k">return</span> <span class="n">proj</span>


<span class="c1"># Note: don&#39;t do &quot;optimization&quot; like this. The contraction will take more time</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">def hop_factory(ltensor, rtensor, mo, dim):</span>
<span class="sd">    h = opt_einsum.contract(&quot;abc, bdeg, fgh -&gt; adfceh&quot;, ltensor, mo, rtensor)</span>
<span class="sd">    if dim == 3:</span>
<span class="sd">        # S-a   f-S</span>
<span class="sd">        #     d</span>
<span class="sd">        # O-b-O-g-O</span>
<span class="sd">        #     e</span>
<span class="sd">        # S-c   h-S</span>
<span class="sd">        def hop(ms):</span>
<span class="sd">            return np.tensordot(h, ms, 3)</span>
<span class="sd">    elif dim == 4:</span>
<span class="sd">        # S-a   f-S</span>
<span class="sd">        #     d</span>
<span class="sd">        # O-b-O-g-O</span>
<span class="sd">        #     e</span>
<span class="sd">        # S-c   h-S</span>
<span class="sd">        #     i</span>
<span class="sd">        def hop(ms):</span>
<span class="sd">            return np.tensordot(h, ms, [[3, 4, 5], [0, 1, 3]]).transpose([0, 1, 3, 2])</span>
<span class="sd">    else:</span>
<span class="sd">        assert False</span>
<span class="sd">    return hop</span>
<span class="sd">&quot;&quot;&quot;</span>


<span class="k">def</span> <span class="nf">hop_factory</span><span class="p">(</span>
    <span class="n">ltensor</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">Matrix</span><span class="p">,</span> <span class="n">xp</span><span class="o">.</span><span class="n">ndarray</span><span class="p">],</span>
    <span class="n">rtensor</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">Matrix</span><span class="p">,</span> <span class="n">xp</span><span class="o">.</span><span class="n">ndarray</span><span class="p">],</span>
    <span class="n">mo</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">Matrix</span><span class="p">,</span> <span class="n">xp</span><span class="o">.</span><span class="n">ndarray</span><span class="p">],</span>
    <span class="n">ndim</span><span class="p">,</span>
<span class="p">):</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ltensor</span><span class="p">,</span> <span class="n">Matrix</span><span class="p">):</span>
        <span class="n">ltensor</span> <span class="o">=</span> <span class="n">ltensor</span><span class="o">.</span><span class="n">array</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">rtensor</span><span class="p">,</span> <span class="n">Matrix</span><span class="p">):</span>
        <span class="n">rtensor</span> <span class="o">=</span> <span class="n">rtensor</span><span class="o">.</span><span class="n">array</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">mo</span><span class="p">,</span> <span class="n">Matrix</span><span class="p">):</span>
        <span class="n">mo</span> <span class="o">=</span> <span class="n">mo</span><span class="o">.</span><span class="n">array</span>
    <span class="c1"># S-a   l-S</span>
    <span class="c1">#     d</span>
    <span class="c1"># O-b-O-f-O</span>
    <span class="c1">#     e</span>
    <span class="c1"># S-c   k-S</span>
    <span class="k">if</span> <span class="n">ndim</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
        <span class="n">path</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="s2">&quot;abc, cek -&gt; abek&quot;</span><span class="p">),</span>
            <span class="p">([</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="s2">&quot;abek, bdef -&gt; akdf&quot;</span><span class="p">),</span>
            <span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="s2">&quot;akdf, lfk -&gt; adl&quot;</span><span class="p">),</span>
        <span class="p">]</span>

        <span class="k">def</span> <span class="nf">hop</span><span class="p">(</span><span class="n">ms</span><span class="p">:</span> <span class="n">xp</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">multi_tensor_contract</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">ltensor</span><span class="p">,</span> <span class="n">ms</span><span class="p">,</span> <span class="n">mo</span><span class="p">,</span> <span class="n">rtensor</span><span class="p">)</span>

        <span class="c1"># S-a   l-S</span>
        <span class="c1">#     d</span>
        <span class="c1"># O-b-O-f-O</span>
        <span class="c1">#     e</span>
        <span class="c1"># S-c   k-S</span>
        <span class="c1">#     g</span>
    <span class="k">elif</span> <span class="n">ndim</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>
        <span class="n">path</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="s2">&quot;abc, bdef -&gt; acdef&quot;</span><span class="p">),</span>
            <span class="p">([</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="s2">&quot;acdef, cegk -&gt; adfgk&quot;</span><span class="p">),</span>
            <span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="s2">&quot;adfgk, lfk -&gt; adgl&quot;</span><span class="p">),</span>
        <span class="p">]</span>

        <span class="k">def</span> <span class="nf">hop</span><span class="p">(</span><span class="n">ms</span><span class="p">:</span> <span class="n">xp</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">multi_tensor_contract</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">ltensor</span><span class="p">,</span> <span class="n">mo</span><span class="p">,</span> <span class="n">ms</span><span class="p">,</span> <span class="n">rtensor</span><span class="p">)</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="k">assert</span> <span class="kc">False</span>

    <span class="k">return</span> <span class="n">hop</span>


<span class="k">def</span> <span class="nf">integrand_func_factory</span><span class="p">(</span><span class="n">shape</span><span class="p">,</span> <span class="n">hop</span><span class="p">,</span> <span class="n">islast</span><span class="p">,</span> <span class="n">S_inv</span><span class="p">:</span> <span class="n">xp</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">left</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
        <span class="n">coef</span><span class="p">:</span> <span class="nb">complex</span><span class="p">,</span> <span class="n">Ovlp_inv1</span><span class="p">:</span> <span class="n">xp</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">Ovlp_inv0</span><span class="p">:</span> <span class="n">xp</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">Ovlp0</span><span class="p">:</span> <span class="n">xp</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="c1"># left == True: projector operate on the left side of the HC</span>
    <span class="c1"># Ovlp0 is (#.conj, #), Ovlp_inv0 = (#, #.conj), Ovlp_inv1 = (#, #.conj)</span>
    <span class="c1"># S_inv is (#.conj, #)</span>
    <span class="k">def</span> <span class="nf">func</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
        <span class="n">y0</span> <span class="o">=</span> <span class="n">y</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">shape</span><span class="p">)</span>
        <span class="n">HC</span> <span class="o">=</span> <span class="n">hop</span><span class="p">(</span><span class="n">y0</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">islast</span><span class="p">:</span>
            <span class="n">proj</span> <span class="o">=</span> <span class="n">projector</span><span class="p">(</span><span class="n">y0</span><span class="p">,</span> <span class="n">left</span><span class="p">,</span> <span class="n">Ovlp_inv1</span><span class="p">,</span> <span class="n">Ovlp0</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">y0</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">left</span><span class="p">:</span>
                    <span class="n">HC</span> <span class="o">=</span> <span class="n">tensordot</span><span class="p">(</span><span class="n">proj</span><span class="p">,</span> <span class="n">HC</span><span class="p">,</span> <span class="n">axes</span><span class="o">=</span><span class="p">([</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">HC</span> <span class="o">=</span> <span class="n">tensordot</span><span class="p">(</span><span class="n">HC</span><span class="p">,</span> <span class="n">proj</span><span class="p">,</span> <span class="n">axes</span><span class="o">=</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">]))</span>
            <span class="k">elif</span> <span class="n">y0</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">left</span><span class="p">:</span>
                    <span class="n">HC</span> <span class="o">=</span> <span class="n">tensordot</span><span class="p">(</span><span class="n">proj</span><span class="p">,</span> <span class="n">HC</span><span class="p">,</span> <span class="n">axes</span><span class="o">=</span><span class="p">([</span><span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">]))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">HC</span> <span class="o">=</span> <span class="n">tensordot</span><span class="p">(</span><span class="n">HC</span><span class="p">,</span> <span class="n">proj</span><span class="p">,</span> <span class="n">axes</span><span class="o">=</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">],</span> <span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">]))</span>
        
        <span class="k">if</span> <span class="n">left</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">Ovlp_inv0</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">HC</span> <span class="o">=</span> <span class="n">tensordot</span><span class="p">(</span><span class="n">Ovlp_inv0</span><span class="p">,</span> <span class="n">HC</span><span class="p">,</span> <span class="n">axes</span><span class="o">=</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
            <span class="k">return</span> <span class="n">tensordot</span><span class="p">(</span><span class="n">HC</span><span class="p">,</span> <span class="n">S_inv</span><span class="p">,</span> <span class="n">axes</span><span class="o">=</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span> <span class="o">/</span> <span class="n">coef</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">Ovlp_inv0</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">HC</span> <span class="o">=</span> <span class="n">tensordot</span><span class="p">(</span><span class="n">HC</span><span class="p">,</span> <span class="n">Ovlp_inv0</span><span class="p">,</span> <span class="n">axes</span><span class="o">=</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">))</span>
            <span class="k">return</span> <span class="n">tensordot</span><span class="p">(</span><span class="n">S_inv</span><span class="p">,</span> <span class="n">HC</span><span class="p">,</span> <span class="n">axes</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span> <span class="o">/</span> <span class="n">coef</span>
        
    <span class="k">return</span> <span class="n">func</span>


<span class="k">def</span> <span class="nf">transferMat</span><span class="p">(</span><span class="n">mps</span><span class="p">,</span> <span class="n">mpsconj</span><span class="p">,</span> <span class="n">domain</span><span class="p">,</span> <span class="n">imps</span><span class="p">,</span> <span class="n">val</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    calculate the transfer matrix from the left hand or the right hand</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="k">if</span> <span class="n">mps</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">domain</span> <span class="o">==</span> <span class="s2">&quot;R&quot;</span><span class="p">:</span>
            <span class="n">val</span> <span class="o">=</span> <span class="n">tensordot</span><span class="p">(</span><span class="n">mpsconj</span><span class="p">[</span><span class="n">imps</span><span class="p">],</span> <span class="n">val</span><span class="p">,</span> <span class="n">axes</span><span class="o">=</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
            <span class="n">val</span> <span class="o">=</span> <span class="n">tensordot</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">mps</span><span class="p">[</span><span class="n">imps</span><span class="p">],</span> <span class="n">axes</span><span class="o">=</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">]))</span>
        <span class="k">elif</span> <span class="n">domain</span> <span class="o">==</span> <span class="s2">&quot;L&quot;</span><span class="p">:</span>
            <span class="n">val</span> <span class="o">=</span> <span class="n">tensordot</span><span class="p">(</span><span class="n">mpsconj</span><span class="p">[</span><span class="n">imps</span><span class="p">],</span> <span class="n">val</span><span class="p">,</span> <span class="n">axes</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
            <span class="n">val</span> <span class="o">=</span> <span class="n">tensordot</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">mps</span><span class="p">[</span><span class="n">imps</span><span class="p">],</span> <span class="n">axes</span><span class="o">=</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]))</span>
    
    <span class="k">elif</span> <span class="n">mps</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">domain</span> <span class="o">==</span> <span class="s2">&quot;R&quot;</span><span class="p">:</span>
            <span class="n">val</span> <span class="o">=</span> <span class="n">tensordot</span><span class="p">(</span><span class="n">mpsconj</span><span class="p">[</span><span class="n">imps</span><span class="p">],</span> <span class="n">val</span><span class="p">,</span> <span class="n">axes</span><span class="o">=</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
            <span class="n">val</span> <span class="o">=</span> <span class="n">tensordot</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">mps</span><span class="p">[</span><span class="n">imps</span><span class="p">],</span> <span class="n">axes</span><span class="o">=</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">],</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">]))</span>
        <span class="k">elif</span> <span class="n">domain</span> <span class="o">==</span> <span class="s2">&quot;L&quot;</span><span class="p">:</span>
            <span class="n">val</span> <span class="o">=</span> <span class="n">tensordot</span><span class="p">(</span><span class="n">mpsconj</span><span class="p">[</span><span class="n">imps</span><span class="p">],</span> <span class="n">val</span><span class="p">,</span> <span class="n">axes</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
            <span class="n">val</span> <span class="o">=</span> <span class="n">tensordot</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">mps</span><span class="p">[</span><span class="n">imps</span><span class="p">],</span> <span class="n">axes</span><span class="o">=</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">]))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;the dim of local mps is not correct: </span><span class="si">{mps[0].ndim}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">val</span>


<span class="k">def</span> <span class="nf">_mu_regularize</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">epsilon</span><span class="o">=</span><span class="mf">1e-10</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    regularization of the singular value of the reduced density matrix</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">epsilon</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">epsilon</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">s</span> <span class="o">+</span> <span class="n">epsilon</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span> <span class="n">s</span> <span class="o">/</span> <span class="n">epsilon</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">BraKetPair</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">bra_mps</span><span class="p">,</span> <span class="n">ket_mps</span><span class="p">,</span> <span class="n">mpo</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="c1"># do copy so that clear_memory won&#39;t clear previous braket</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bra_mps</span> <span class="o">=</span> <span class="n">bra_mps</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ket_mps</span> <span class="o">=</span> <span class="n">ket_mps</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mpo</span> <span class="o">=</span> <span class="n">mpo</span>
        <span class="c1"># for adaptive evolution. This is not an ideal solution but</span>
        <span class="c1"># I can&#39;t find anyone better. Bra and Ket have the same step size during</span>
        <span class="c1"># the evolution. Is this necessary?</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">evolve_config</span> <span class="o">=</span> <span class="n">ket_mps</span><span class="o">.</span><span class="n">evolve_config</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ft</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calc_ft</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">calc_ft</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mpo</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">dot</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bra_mps</span><span class="o">.</span><span class="n">conj</span><span class="p">()</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ket_mps</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">dot</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bra_mps</span><span class="o">.</span><span class="n">conj</span><span class="p">()</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mpo</span> <span class="o">@</span> <span class="bp">self</span><span class="o">.</span><span class="n">ket_mps</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">(</span>
            <span class="n">dot</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">conjugate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bra_mps</span><span class="o">.</span><span class="n">coeff</span><span class="p">)</span>
            <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">ket_mps</span><span class="o">.</span><span class="n">coeff</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">iscomplexobj</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ft</span><span class="p">):</span>
            <span class="c1"># if negative, sign is included in the imag part</span>
            <span class="n">sign</span> <span class="o">=</span> <span class="s2">&quot;+&quot;</span> <span class="k">if</span> <span class="mi">0</span> <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ft</span><span class="o">.</span><span class="n">imag</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span>
            <span class="n">ft_str</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%g%s%g</span><span class="s2">j&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ft</span><span class="o">.</span><span class="n">real</span><span class="p">,</span> <span class="n">sign</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ft</span><span class="o">.</span><span class="n">imag</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ft_str</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%g</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">ft</span>
        <span class="k">return</span> <span class="s2">&quot;bra: </span><span class="si">%s</span><span class="s2">, ket: </span><span class="si">%s</span><span class="s2">, ft: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bra_mps</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ket_mps</span><span class="p">,</span> <span class="n">ft_str</span><span class="p">)</span>

    <span class="c1"># todo: not used?</span>
    <span class="k">def</span> <span class="nf">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">iter</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">bra_mps</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ket_mps</span><span class="p">))</span>


<span class="k">def</span> <span class="nf">min_abs</span><span class="p">(</span><span class="n">t1</span><span class="p">,</span> <span class="n">t2</span><span class="p">):</span>
    <span class="c1"># t1, t2 could be int, float, complex</span>
    <span class="c1"># return the number with smaller norm</span>

    <span class="k">assert</span> <span class="n">xp</span><span class="o">.</span><span class="n">iscomplex</span><span class="p">(</span><span class="n">t1</span><span class="p">)</span> <span class="o">==</span> <span class="n">xp</span><span class="o">.</span><span class="n">iscomplex</span><span class="p">(</span><span class="n">t2</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">xp</span><span class="o">.</span><span class="n">absolute</span><span class="p">(</span><span class="n">t1</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">xp</span><span class="o">.</span><span class="n">absolute</span><span class="p">(</span><span class="n">t2</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">t1</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">t2</span>
</pre></div>

           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2019, Shuaigroup

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>